<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<title>Hora Extra | Subcontratada</title>
<link rel="icon" type="image/png" href="./favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="./favicon/favicon.svg" />
<link rel="shortcut icon" href="./favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png" />
<link rel="manifest" href="./favicon/site.webmanifest" />
<!-- jsPDF (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root {
    --bg: #0b0c0f;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --accent: #9fccb1;
    --accent-strong: #3b82f6;
    --secondary: #39666b;
    --text: #e1efe6;
    --muted: rgba(225,239,230,0.68);
    --muted-2: rgba(225,239,230,0.48);
    --neumo-shadow: 0 8px 20px rgba(0,0,0,0.45);
    --radius: 14px;
    --max-width: 1200px;
    --gap: 18px;
    --btn-grad: linear-gradient(135deg,#4f46e5,#7c3aed);
    --btn-glow-grad: linear-gradient(135deg, rgba(79,70,229,0.28), rgba(124,58,237,0.28));
    --cta-contrast: #ffffff;
    --hover-ease: cubic-bezier(.15,.9,.25,1);
    --danger: #ef4444;
    --warning: #f59e0b;
    --success: #10b981;
    --sidebar-w: 260px;
    --soft-border: rgba(255,255,255,0.08);
    --input-bg: rgba(255,255,255,0.02);
    --input-border: rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(57,102,107,0.08), transparent), var(--bg);
    color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding:32px; display:flex; align-items:flex-start; justify-content:center;
  }
  .wrap{width:100%;max-width:var(--max-width);}

  /* Header */
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:grid;place-items:center;border:1px solid var(--soft-border);box-shadow:var(--neumo-shadow);}
  .logo img{width:28px;height:28px}
  h1{font-size:18px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  /* layout */
  .grid{display:grid;grid-template-columns:1fr 380px;gap:var(--gap)}
  @media (max-width:980px){.grid{grid-template-columns:1fr;gap:14px} .notification-content button {
        width: 100%;
        padding: 12px;
        font-size: 16px;
      }}

  /* main card */
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.018), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;border:1px solid var(--soft-border);box-shadow:var(--neumo-shadow)}

  /* controls */
  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    border:0;
    padding:10px 14px;
    border-radius:10px;
    background: var(--btn-grad);
    color: var(--cta-contrast);
    font-weight:600;
    cursor:pointer;
    position:relative;
    z-index:0;
    transition:transform .12s var(--hover-ease), box-shadow .12s var(--hover-ease);
    box-shadow: 0 8px 24px rgba(59,40,179,0.18);
    overflow:visible;
  }
  .btn::after{
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    z-index: -1;
    background: var(--btn-glow-grad);
    filter: blur(14px);
    opacity: 0;
    transition: opacity .18s ease;
  }
  .btn:hover{ transform: translateY(-4px); }
  .btn:hover::after{ opacity:1; }
  .btn.secondary{ background: transparent; border: 1px solid var(--soft-border); color: var(--muted); box-shadow:none; }
  .btn.ghost{ background: transparent; border: 1px dashed var(--input-border); color: var(--muted); }
  .btn i{ width:18px; text-align:center; font-size:14px; display:inline-block; }

  .btn.secondary::after,
.btn.ghost::after,
.btn--clear::after,
.btn--export::after {
  display: none !important;
  opacity: 0 !important;
}

.btn.secondary,
.btn.ghost,
.btn--clear {
  box-shadow: none !important;
}

.btn--export {
  --shadow: 79,70,229;
  background: linear-gradient(180deg, rgba(var(--shadow),0.06), rgba(124,58,237,0.06));
  color: var(--cta-contrast);
  border: 1px solid rgba(124,58,237,0.18);
  transition: transform .14s var(--hover-ease), background .12s ease;
}
.btn--export:hover{
  transform: translateY(-3px);
}

/* ---------------- Clear (vermelho) ---------------- */
.btn--clear {
  --shadow: 239,68,68;
  background: linear-gradient(180deg, rgba(var(--shadow),0.04), rgba(var(--shadow),0.02));
  color: var(--danger);
  border: 1px solid rgba(var(--shadow),0.12);

  box-shadow: 0 4px 12px rgba(var(--shadow), 0.06);
  transition: transform .14s var(--hover-ease), background .12s ease;
}
.btn--clear:hover{
  transform: translateY(-3px);
}

  /* list */
  .list{margin-top:14px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .list header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
  .list header .title{font-weight:700}
  .table-wrap{overflow:auto;width:100%} /* permite rolagem horizontal em telas pequenas */
  .list table{width:100%;border-collapse:collapse;min-width:920px} /* aumentei um pouco para a nova coluna */
  .list thead th{font-size:12px;text-align:left;padding:12px 14px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.02)}
  .list thead th:nth-child(2){padding: 0px 25px;}
  .list tbody tr{background:linear-gradient(180deg, var(--card), transparent)}
  .list tbody td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:14px;vertical-align:middle}
  .muted{color:var(--muted)}

  /* small pill */
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px;border:1px solid rgba(255,255,255,0.02); color:var(--text)}

/* sidebar form */
  .side{position:relative}
  .controls-block{display:flex;flex-direction:column;gap:12px}
  label{font-size:13px;color:var(--muted);display:block}
  input[type=text], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;font-size:14px}
  textarea{min-height:90px;resize:none}
  .small-muted{font-size:12px;color:var(--muted)}

/* sticky behavior only on larger screens */
  .side .sticky{position:sticky;top:18px}

/* modal */
  .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,4,4,0.6);z-index:60}
  .modal-window{width:100%;max-width:520px;background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--soft-border);}

  @media (max-width: 1000px) {
  .modal-window {
    background: rgba(11,12,15,0.98) !important;
    box-shadow: 0 18px 46px rgba(0,0,0,0.65) !important;
    border: 1px solid rgba(255,255,255,0.03) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
}

  .row{display:flex;gap:10px}
  .row .col{flex:1}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* empty state */
  .empty{padding:28px;text-align:center;color:var(--muted);}

  .time{font-size:12px;color:var(--muted-2)}

/* tiny helpers */
  .icon-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px;
  border-radius: 8px;
  background: transparent;
  border: 0;
  color: var(--muted);
  cursor: pointer;
  transition: all .12s;
}

/* estilos semânticos para os ícones */
.icon-btn.remove { color: #ff6b6b; }   /* remover com tom avermelhado */
.icon-btn.edit   { color: var(--accent); } /* editar com cor de destaque */

.icon-btn.remove:hover{
  color: red;
}

.icon-btn.edit:hover{
  color: var(--secondary);
}

/* make the action cell a predictable flex container with gap */
.list tbody tr td:last-child {
  justify-content: flex-end; /* mantém os botões à direita na tabela */
  gap: 20px;                 /* espaçamento consistente entre editar/remover */
}

/* Quando o layout vira "stacked" em telas ≤640 (cada td vira uma linha),
   garantimos que a célula de ações mantenha os botões bem posicionados */
@media (max-width: 640px) {
  .icon-btn { font-size: 15px; }
}
.edit { margin: 0 !important; }

  /* animation */
  .fade-in{animation:fadeIn .18s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* ----------------- MOBILE ADJUSTMENTS ----------------- */
  @media (max-width:980px){
    body{padding:16px; background: radial-gradient(600px 300px at 10% 10%, rgba(57,102,107,0.04), transparent), var(--bg);}
    .wrap{max-width:980px}
    .topbar{flex-direction:column;align-items:flex-start;gap:10px}
    .controls{width:100%;display:flex;gap:8px;flex-wrap:wrap}
    .controls .btn{flex:1;min-width:120px}
    .card{padding:14px}
    .list header{padding:10px}
    .list thead th, .list tbody td{padding:9px}
    .pill{font-size:11px;padding:5px 7px}
    .logo{width:38px;height:38px}
    .logo img{width:22px;height:22px}

    /* Disable sticky behavior on small screens so summary doesn't 'subir junto' */
    .side .sticky{position:static;top:auto}
    /* Ensure aside content flows naturally under main */
    .side{order:2}
    main{order:1}

    /* make the instruction card compact */
    #instructionsCard{margin-top:10px;padding:10px}
    /* reduce table min width for smaller devices */
    .list table{min-width:720px}
  }

  /* Responsive table -> stacked cards on narrow screens */
  @media (max-width:640px){
    .table-wrap{overflow:visible} /* allow stacked flow */
    .list table{min-width:0;border:0}
    .list thead{display:none}
    .list tbody tr{display:block;margin-bottom:10px;padding:12px;border-radius:10px;background:var(--card);border:1px solid rgba(255,255,255,0.02)}
    .list tbody td{display:flex;justify-content:space-between;padding:8px 0;border-bottom:0}
    .list tbody td + td{margin-top:6px}
    .list tbody td:before{content:attr(data-label);display:inline-block;color:var(--muted);margin-right:10px;font-size:13px;min-width:96px}
    .list tbody td .pill{padding:4px 7px;font-size:12px}
    .list tbody td .icon-btn{padding:6px}
    .list tbody td .time{font-size:12px;color:var(--muted-2)}
  }

  /* very small screens tweaks */
  @media (max-width:420px){
    .btn{padding:9px 10px;font-size:13px}
    .btn i{width:16px}
    .logo{width:34px;height:34px}
  }

  .side .sticky{position:static;top:auto}

  /* ===== SCROLLBAR STYLING ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(159, 204, 177, 0.3);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(159, 204, 177, 0.5);
    }

    /* ===== MODAL STYLING ===== */
    .notification-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: modalFadeIn 0.3s var(--hover-ease);
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .notification-content {
      background: linear-gradient(180deg, rgba(11,12,15,0.95), rgba(16,18,17,0.98));
      border: 1px solid rgba(110,116,120,0.10);
      padding: 28px 32px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      animation: modalSlideIn 0.4s var(--hover-ease);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .notification-content p {
      margin-bottom: 20px;
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
      font-weight: 400;
    }

    /* ===== NOTIFICATION ICONS ===== */
    #notificationMessage {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  text-align: center;
}

    /* floating modal notification */
    .notification-modal{ 
  position: fixed; 
  inset: 0; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  background: rgba(0,0,0,0.7); 
  backdrop-filter: blur(4px);
  z-index: 600;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  will-change: transform;
}
.notification-modal.show {
  opacity: 1;
  visibility: visible;
}

    .notification-content{
  background: rgba(11, 12, 15, 0.95);
  backdrop-filter: blur(20px) saturate(130%);
  padding: 20px 28px;
  border-radius: 16px;
  max-width: 420px;
  width: 92%;
  border: 1px solid rgba(255,255,255,0.12);
 box-shadow: 0 8px 20px rgba(0,0,0,0.45);
  color: var(--text);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  transform: scale(0.9) translateY(20px);
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.notification-modal.show .notification-content {
  transform: scale(1) translateY(0);
}

    .notification-content button{
  margin-top: 20px;
  display: inline-block;
  border-radius: 12px;
  padding: 12px 24px;
  border: 1px solid rgba(255,255,255,0.08);
  cursor: pointer;
  background: var(--btn-grad);
  color: white;
  font-weight: 700;
  transition: all 0.3s ease;
  font-size: 14px;
  filter: drop-shadow(0 0 20px rgba(79, 70, 229, 0.4)) drop-shadow(0 0 40px rgba(79, 70, 229, 0.2));
}

/* Estilos para os ícones das notificações */
.notification-icon {
  font-size: 45px;
  margin-bottom: 8px;
  position: relative;
  display: block;
  text-align: center;
  width: 100%;
}

.notification-icon.success {
  color: #28a745;
  filter: drop-shadow(0 0 20px rgba(40, 167, 69, 0.4)) drop-shadow(0 0 40px rgba(40, 167, 69, 0.2));
}

.notification-icon.error {
  color: #dc3545;
  filter: drop-shadow(0 0 20px rgba(220, 53, 69, 0.4)) drop-shadow(0 0 40px rgba(220, 53, 69, 0.2));
}

.notification-icon.warning {
  color: #ffc107;
  filter: drop-shadow(0 0 20px rgba(255, 193, 7, 0.4)) drop-shadow(0 0 40px rgba(255, 193, 7, 0.2));
}

.notification-icon.info {
  color: #2196f3;
  filter: drop-shadow(0 0 20px rgba(33, 150, 243, 0.4)) drop-shadow(0 0 40px rgba(33, 150, 243, 0.2));
}

.notification-text {
  font-size: 16px;
  line-height: 1.5;
  color: var(--text);
  margin: 0;
  text-align: center;
}

@media (max-width: 600px), (max-device-width: 800px) {
  .notification-modal{ background: rgba(0,0,0,0.55); }
}

/* ===== SELECT STYLING ===== */
    select, .select-like{
  background-color: var(--input-bg) !important; color:var(--text) !important; border:1px solid var(--input-border) !important;
  -webkit-appearance:none; -moz-appearance:none; appearance:none; padding-right:35px !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23e1efe6' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") !important;
  background-repeat:no-repeat !important; background-position:right 12px center !important; background-size:16px 16px !important;
}
select option{ background-color:var(--bg) !important; color:var(--text) !important; }
select option:hover, select option:checked{ background:var(--accent) !important; color:#0b150f !important; }
select option[disabled]{ color:var(--muted) !important; }

/* ===== AUTOFILL DARK ===== */
   input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill{
  -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
  box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
  -webkit-text-fill-color: var(--text) !important;
  transition: background-color 5000s ease-in-out 0s !important;
}
input:-webkit-autofill:focus{ -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important; }

@media (hover: none) and (pointer: coarse) {
  a, button, input, textarea {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }
}

  .dev-note {
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding:12px 10px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow: var(--neumo-shadow);
    }
    .dev-note strong { color:var(--text); letter-spacing:0.01em; font-weight:700; }
    .dev-note .meta { display:block; margin-top:6px; color: rgba(225,239,230,0.45); font-size:11px; }

/* ===== UX ADDITIONS (required marker, errors, changed highlight, snackbar) ===== */
label.required::after {
  content: " *";
  color: var(--danger);
  margin-left: 4px;
  font-weight:700;
}

/* input states */
.field-error {
  border-color: rgba(239,68,68,0.95) !important;
  box-shadow: 0 6px 18px rgba(239,68,68,0.08);
  animation: shake .18s linear both;
}
@keyframes shake {
  0%{ transform: translateX(0) } 25%{ transform: translateX(-4px) } 50%{ transform: translateX(3px) } 75%{ transform: translateX(-2px) } 100%{ transform:none }
}

.field-changed {
  box-shadow: 0 0 0 4px rgba(159,204,177,0.08);
  border-color: var(--accent) !important;
}

/* helper/error text below fields */
.field-help {
  margin-top:-6px;
  font-size:12px;
  color:var(--muted);
}
.field-error + .field-help,
.field-help.error { color: var(--danger); }

/* disabled button visual */
.btn[disabled], .btn[aria-disabled="true"] { opacity:0.5; pointer-events:none; }

/* snackbar undo */
.snackbar {
  position: fixed;
  right: 20px;
  bottom: 20px;
  background: linear-gradient(180deg, rgba(11,12,15,0.98), rgba(20,20,20,0.98));
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--text);
  padding: 12px 16px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  display:flex;
  gap:10px;
  align-items:center;
  z-index:9999;
  transform: translateY(10px);
  opacity:0;
  transition: all .24s ease;
}
.snackbar.show{ opacity:1; transform: translateY(0); }
.snackbar button { background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:8px; cursor:pointer; }

#snackUndo{
  display:inline-flex;
    align-items:center;
    gap:10px;
    border:0;
    padding:10px 14px;
    border-radius:10px;
    background: var(--btn-grad);
    color: var(--cta-contrast);
    font-weight:600;
    cursor:pointer;
    position:relative;
    z-index:0;
    transition:transform .12s var(--hover-ease), box-shadow .12s var(--hover-ease);
    box-shadow: 0 8px 24px rgba(59,40,179,0.18);
    overflow:visible;
}

/* small hint icon next to inputs */
.input-hint {
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  color:var(--muted);
}
.input-hint i { font-size:13px; color:var(--muted); }


/* Floating FAB — estilo pronto */
.fab-export{
  position: fixed;
  right: 20px;
  bottom: 20px;
  border-radius: 999px;
  width: 56px;
  height: 56px;
  padding: 0;
  display: inline-grid;
  place-items: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  z-index: 1200;
  font-size: 18px;
}

/* optional: esconder o Export no topbar em telas pequenas para evitar confusão */
@media (max-width: 980px) {
  /* esconde o botão de export no topbar (se quiser) */
  #btnExport { display: none !important; }
}

@media (min-width: 1000px) {
  /* esconde o botão de export no topbar (se quiser) */
  .fab-export { display: none !important; }
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="./favicon/favicon.svg" alt="" style="width: 55%;">
        </div>
        <div>
          <h1>Hora Extra | Subcontratada</h1>
          <p class="lead">Registre rapidamente Nome, Subcontratada (preencha uma vez), OT e Motivo.</p>
        </div>
      </div>
      <div class="controls">
        <button id="btnAddMember" class="btn"><i class="fa-solid fa-user-plus"></i> Adicionar Membro</button>
        <button id="btnExport" class="btn btn--export"><i class="fa-solid fa-download"></i></i> Exportar</button>
        <button id="btnClear" class="btn btn--clear"><i class="fa-solid fa-trash"></i> Limpar</button>
      </div>
    </div>

    <div class="grid">
      <main class="card" id="mainCard">
        <div class="list fade-in">
          <header>
            <div class="title">Lista de Horas Extras <span id="countPill" class="pill">0</span></div>
            <div class="time" id="lastUpdate">—</div>
          </header>

          <div id="tableWrap" class="table-wrap">
            <table id="membersTable" aria-live="polite">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>OT</th>
                  <th>Subcontratada</th>
                  <th>Motivo</th>
                  <th>Dia HE</th>
                  <th>Adicionado</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <!-- rows -->
              </tbody>
            </table>
          </div>

          <div id="emptyState" class="empty">Nenhum registro ainda. Clique em "Adicionar Membro" para começar.</div>
        </div>
      </main>

      <aside class="side">
        <!-- sticky class aplicado só em telas maiores via CSS; em mobile ele fica estático -->
        <div class="card sticky">
          <h3 style="margin-top:0;margin-bottom:8px">Adicionar rapidamente</h3>
          <div class="controls-block">
            <label for="companyName" class="required">Subcontratada (preencha apenas uma vez)</label>
            <input id="companyName" type="text" placeholder="Nome da Subcontratada (ex: Empresa X)" />
            <div class="field-help">Preencha apenas uma vez; será aplicada a todos os registros.</div>

            <label for="quickName" class="required">Nome</label>
            <input id="quickName" type="text" autocomplete="off" placeholder="Nome do colaborador" />
            <div class="field-help">Use o nome oficial (ex: João Silva)</div>

            <label for="quickOT" class="required">OT (Embarcação)</label>
            <input id="quickOT" type="text" inputmode="numeric" pattern="\d*" maxlength="6" placeholder="Ex: 430" autocomplete="off" aria-label="OT (somente números)" />
            <div class="field-help">Digite apenas números. Ex: 430</div>

            <label for="quickMotivo" class="required">Motivo <span class="small-muted">(ex: Bloco D1)</span></label>
            <input id="quickMotivo" type="text" autocomplete="off" maxlength="100" placeholder="Ex: Bloco D1" />
            <div class="field-help">Use descrição curta do local/trabalho.</div>

            <label for="quickDia">Dia da hora extra</label>
            <select id="quickDia" aria-label="Dia da hora extra">
              <option value="hoje" selected>Hoje</option>
              <option value="sabado">Sábado (próximo)</option>
            </select>

            <div style="display:flex;gap:8px">
              <button id="quickAdd" class="btn" style="flex:1"><i class="fa-solid fa-user-plus"></i>Adicionar</button>
              <button id="quickClear" class="btn secondary" style="flex:1"><i class="fa-solid fa-trash"></i>Limpar campos</button>
            </div>
            <p class="small-muted" style="margin-top:8px">Dica: pressione Enter em qualquer campo para adicionar. Use <strong>Ctrl+Enter</strong> para adicionar rapidamente.</p>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card" id="summaryCard">
          <h4 style="margin:0 0 8px 0">Resumo</h4>
          <p class="muted" id="summaryText">Nenhum registro.</p>
        </div>
      </aside>
    </div>

    <!-- instruções (fixas) -->
    <div class="card" id="instructionsCard" style="margin-top:12px;margin-bottom:6px;padding:12px;border-radius:12px;">
      <div style="display:flex;align-items:flex-start;gap:12px">
        <i class="fa-solid fa-circle-info" style="font-size:20px;color:var(--accent)"></i>
        <div>
          <strong style="display:block;margin-bottom:6px">Instruções de Uso</strong>
          <div style="font-size:13px;color:var(--muted);">
            <div class="instr-step"><strong>Passo a passo</strong>
              <ol style="margin:6px 0 8px 18px;color:var(--muted)">
                <li>Preencha <strong>Subcontratada</strong> uma única vez no formulário à direita.</li>
                <li>Use o campo <strong>Nome</strong> para adicionar cada colaborador (sem apelidos).</li>
                <li>Preencha <strong>OT (Embarcação)</strong>: digite apenas números (ex: 430).</li>
                <li>Preencha <strong>Motivo</strong>: detalhe sucinto (ex: Bloco D1).</li>
                <li>Escolha o <strong>Dia da hora extra</strong> (Hoje ou Sábado) - será usado no "Dia HE".</li>
                <li>Clique em "Adicionar" para gravar ou use Enter; use "Exportar" para baixar os dados.</li>
              </ol>
            </div>
            <div style="margin-top:6px"><strong>Regras importantes</strong>
              <ul style="margin:6px 0 0 18px;color:var(--muted)">
                <li><strong>Sem apelidos:</strong> o campo Nome deve conter o nome oficial do colaborador (ex.: João Silva, não "Joãozinho").</li>
                <li><strong>Nomes repetidos:</strong> se houver colaboradores com o mesmo nome, informe também o <em>sobrenome</em>.</li>
                <li><strong>Subcontratada:</strong> preencha apenas uma vez; será aplicada a todos os colaboradores adicionados.</li>
                <li><strong>OT:</strong> somente números; entradas com letras serão recusadas.</li>
                <li><strong>Motivo:</strong> use informações do bloco e local em que vai ser trabalhado (ex.: "Bloco D1").</li>
              </ul>
            </div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">Observação: estas instruções não são fixas e podem ser alteradas conforme necessário.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="dev-note reveal">
        <div>Sistema desenvolvido por <strong>Gustavo Carvalho</strong></div>
        <div>Setor de <strong>Estrutura</strong></div>
        <span class="meta">Agilidade, confiabilidade e design de excelência — pensado para líderes de obra que buscam precisão e confiança • © 2025</span>
      </div>
  </div>

  </div>

  <!-- modal -->
  <div id="modalBack" class="modal-backdrop" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 8px">Adicionar Membro</h3>
      <div>
        <div class="row">
          <div class="col">
            <label class="required">Nome</label>
            <input id="modalName" type="text" placeholder="Nome do colaborador" />
            <div class="field-help"></div>
          </div>
        </div>
        <div style="height:10px"></div>
        <label class="required">OT (Embarcação)</label>
        <input id="modalOT" type="text" inputmode="numeric" pattern="\d*" maxlength="6" placeholder="Ex: 430" aria-label="OT (somente números)" />
        <div class="field-help">Digite apenas números.</div>
        <div style="height:10px"></div>
        <label class="required">Motivo</label>
        <textarea id="modalMotivo" placeholder="Ex: Bloco D1"></textarea>
        <div class="field-help">Descrição curta do local/trabalho.</div>

        <div style="height:10px"></div>
        <label>Dia da hora extra</label>
        <select id="modalDia">
          <option value="hoje" selected>Hoje</option>
          <option value="sabado">Sábado (próximo)</option>
        </select>

        <div class="actions">
          <button id="modalCancel" class="btn secondary">Cancelar</button>
          <button id="modalSave" class="btn">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modais e indicadores -->
  <div id="notificationModal" class="notification-modal" style="display:none">
    <div class="notification-content">
      <p id="notificationMessage" style="display:flex;align-items:center;gap:10px">
        <i class="fas fa-info-circle" style="color:var(--accent-strong);"></i>
        <span id="notificationText">Mensagem</span>
      </p>
      <div style="display:flex;justify-content:center">
        <button id="notificationOkBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- snackbar (undo) — criado dinamicamente se necessário, mas incluí aqui por segurança -->
  <div id="snackbar" class="snackbar" style="display:none"></div>
  <button id="btnExportFab" class="btn fab-export" aria-label="Exportar" title="Exportar (rápido)">
  <i class="fa-solid fa-download"></i>
</button>

<script>
document.addEventListener('DOMContentLoaded', () => {
  setupModalHandlers();

  const fab = document.getElementById('btnExportFab');
  const original = document.getElementById('btnExport');

  if(!fab) return;
  fab.addEventListener('click', function(e){
    // respeita o estado desabilitado do FAB
    if (fab.disabled) return;

    // se o botão original existe e não estiver desabilitado, dispara o click nele
    if (original && !original.disabled) {
      original.click();
      return;
    }

    // se o botão original existe mas está desabilitado, não faz nada
    if (original && original.disabled) return;

    // fallback para caso a lógica use um evento custom
    const evt = new Event('export:trigger');
    document.dispatchEvent(evt);
  });
});


// ========================== MAIN IIFE (com melhorias UX integradas) ==========================
(function(){
  // ---------- ELEMENTS ----------
  const btnAddMember = document.getElementById('btnAddMember');
  const btnExport = document.getElementById('btnExport'); // gera PDF agora
  const btnExportFab = document.getElementById('btnExportFab'); // o FAB (pode ser null)
  const btnClear = document.getElementById('btnClear');
  const tableBody = document.querySelector('#membersTable tbody');
  const emptyState = document.getElementById('emptyState');
  const countPill = document.getElementById('countPill');
  const lastUpdate = document.getElementById('lastUpdate');
  const summaryText = document.getElementById('summaryText');

  const modalBack = document.getElementById('modalBack');
  const modalName = document.getElementById('modalName');
  const modalOT = document.getElementById('modalOT');
  const modalMotivo = document.getElementById('modalMotivo');
  const modalDia = document.getElementById('modalDia');
  const modalCancel = document.getElementById('modalCancel');
  const modalSave = document.getElementById('modalSave');

  const quickName = document.getElementById('quickName');
  const quickOT = document.getElementById('quickOT');
  const quickMotivo = document.getElementById('quickMotivo');
  const quickDia = document.getElementById('quickDia');
  const quickAdd = document.getElementById('quickAdd');
  const quickClear = document.getElementById('quickClear');

  const companyNameInput = document.getElementById('companyName');

  let members = [];
  let editingIndex = null; // índice do membro em edição (null = modo adicionar)
  let lastRemoved = null;  // suporte undo

  // ---------- UTILITIES ----------
  function fmtTime(d){
    const dt = new Date(d);
    return dt.toLocaleString();
  }

  // Accepts either 'YYYY-MM-DD' (local date) OR a full ISO string; returns dd/mm/yyyy
  function fmtDateISOtoDisplay(iso){
    if(!iso) return '—';
    try{
      if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){
        const [yy,mm,dd] = iso.split('-').map(Number);
        const d = new Date(yy, mm-1, dd); // local midnight
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      }
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    }catch(e){ return iso; }
  }

  function getCompanyName(){
    return (companyNameInput.value || '').trim();
  }

  function localDateToYYYYMMDD(dateObj){
    const d = dateObj instanceof Date ? dateObj : new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function computeDateForChoice(choice){
    const now = new Date();
    if(choice === 'hoje') {
      const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // local midnight
      return localDateToYYYYMMDD(d);
    }
    if(choice === 'sabado') {
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const day = today.getDay();
      const delta = (6 - day + 7) % 7;
      const target = new Date(today);
      target.setDate(today.getDate() + delta);
      const norm = new Date(target.getFullYear(), target.getMonth(), target.getDate());
      return localDateToYYYYMMDD(norm);
    }
    return localDateToYYYYMMDD(new Date(now.getFullYear(), now.getMonth(), now.getDate()));
  }

  // ---------- RENDER TABLE (OT after Name) ----------
  function render(){
    tableBody.innerHTML = '';
    const company = getCompanyName();
    if(members.length === 0){
      emptyState.style.display = 'block';
      document.getElementById('tableWrap').style.display = 'none';
    } else {
      emptyState.style.display = 'none';
      document.getElementById('tableWrap').style.display = 'block';
    }

    members.forEach((m, idx)=>{
      const heDateDisplay = fmtDateISOtoDisplay(m.extraDate || m.addedAt);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Nome"><strong>${escapeHtml(m.name)}</strong></td>
        <td data-label="OT"><span class="pill">${escapeHtml(m.ot)}</span></td>
        <td data-label="Subcontratada">${escapeHtml(company)}</td>
        <td data-label="Motivo" class="muted">${escapeHtml(m.motivo)}</td>
        <td data-label="Dia HE" class="time">${heDateDisplay}</td>
        <td data-label="Adicionado" class="time">${fmtTime(m.addedAt)}</td>
        <td data-label="" style="text-align:right">
          <button class="icon-btn edit" data-idx="${idx}" title="Editar" aria-label="Editar registro"><i class="fa-solid fa-pen"></i></button>
          <button class="icon-btn remove" data-idx="${idx}" title="Remover" aria-label="Remover registro"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;
      tableBody.appendChild(tr);
    });

    // listeners
    tableBody.querySelectorAll('button.icon-btn.remove').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-idx'));
        if (!Number.isNaN(i)) removeAt(i);
      });
    });
    tableBody.querySelectorAll('button.icon-btn.edit').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-idx'));
        if (!Number.isNaN(i)) openEditModal(i);
      });
    });

    countPill.textContent = String(members.length);
    lastUpdate.textContent = members.length ? `Último: ${fmtTime(members[members.length-1].addedAt)}` : '—';
    summaryText.textContent = members.length ? `${members.length} registro(s) nesta sessão.` : 'Nenhum registro.';

    try{
      sessionStorage.setItem('he_sub_members', JSON.stringify(members));
      sessionStorage.setItem('he_sub_company', getCompanyName());
    }catch(e){}

    // Update exporting availability
    refreshExportState();
  }

  // ---------- removeAt with UNDO ----------
  function removeAt(i){
    if(i < 0 || i >= members.length) return;
    const removed = members.splice(i,1)[0];
    // save removed for undo
    lastRemoved = { member: removed, index: i };
    render();
    showSnackbar('Registro removido', (didUndo) => {
      if(didUndo){
        // restore
        members.splice(lastRemoved.index, 0, lastRemoved.member);
        lastRemoved = null;
        render();
      } else {
        // permanent: nothing to do (already removed)
        lastRemoved = null;
      }
    });
  }

  // ----------------- HELPERS PARA NORMALIZAÇÃO/COMPARAÇÃO -----------------
function normalizeName(s) {
  // remove acentos, normaliza espaços e transforma em lower case para comparação
  if (!s) return '';
  const cleaned = String(s)
    .normalize('NFD')                      // separa diacríticos
    .replace(/[\u0300-\u036f]/g, '')       // remove acentos/diacríticos
    .replace(/\s+/g, ' ')                  // colapsa espaços múltiplos
    .trim()
    .toLowerCase();
  return cleaned;
}

// ----------------- addMember (substituir a existente) -----------------
function addMember(name, ot, motivo, extraDate){
  const company = getCompanyName();
  name = (name||'').trim();
  ot = (ot||'').trim();
  motivo = (motivo||'').trim();
  extraDate = extraDate || localDateToYYYYMMDD(new Date());

  if(!company) return {ok:false,msg:'Preencha o campo "Subcontratada" antes de adicionar colaboradores.'};
  if (hasInvalidNameChars(company)) return {ok:false,msg:'Nome da Subcontratada contém caracteres inválidos ou números.'};

  if(!name) return {ok:false,msg:'Nome é obrigatório.'};
  if (hasInvalidNameChars(name)) return {ok:false,msg:'Nome do colaborador contém números ou caracteres inválidos.'};

  if(!ot || !/^\d+$/.test(ot)) return {ok:false,msg:'OT (Embarcação) é obrigatório e deve conter apenas números.'};
  if(!motivo) return {ok:false,msg:'Motivo é obrigatório.'};

  // --- Verificações de duplicata ---
  const normNew = normalizeName(name);
  // 1) duplicata exata (mesmo nome completo)
  if (members.some(m => normalizeName(m.name) === normNew)) {
    return { ok: false, msg: 'Colaborador já foi adicionado. Por favor inclua o sobrenome para diferenciar.' };
  }

  // 2) se o usuário inseriu apenas o primeiro nome (ex: "João"), e já existe alguém com esse primeiro nome,
  // avisar para adicionar sobrenome (não bloquear se o usuário já colocou sobrenome)
  const words = name.split(/\s+/).filter(Boolean);
  if (words.length === 1) {
    const first = normNew; // já é o primeiro nome normalizado
    const conflictFirst = members.some(m => normalizeName(m.name).split(' ')[0] === first);
    if (conflictFirst) {
      return { ok: false, msg: 'Já existe colaborador com esse primeiro nome. Adicione o sobrenome.' };
    }
  }

  // se passou nas verificações, adiciona
  members.push({name,ot,motivo,addedAt:new Date().toISOString(), extraDate});
  render();
  return {ok:true};
}

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; });
  }

  function onlyDigitsInput(el, maxLen=6){
    if(!el) return;
    el.addEventListener('input', ()=>{
      const v = el.value.replace(/\D/g,'').slice(0,maxLen);
      if(el.value !== v) el.value = v;
    });
    el.addEventListener('paste', (e)=>{
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,maxLen);
      const start = el.selectionStart || el.value.length;
      const before = el.value.slice(0, start);
      const after = el.value.slice((el.selectionEnd || start));
      el.value = (before + text + after).slice(0, maxLen);
      const pos = Math.min((before+text).length, maxLen);
      el.setSelectionRange(pos,pos);
      el.dispatchEvent(new Event('input', { bubbles: true }));
    });
    el.addEventListener('keydown', (e)=>{
      const allowedKeys = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
      if(allowedKeys.includes(e.key)) return;
      if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','A','C','V','X'].includes(e.key)) return;
      if(!/^[0-9]$/.test(e.key)) e.preventDefault();
    });
  }
  onlyDigitsInput(quickOT, 6);
  onlyDigitsInput(modalOT, 6);

  function onlyLettersInput(el, maxLen = 80) {
    if (!el) return;
    const sanitize = (s) => {
      s = String(s || '').normalize('NFKC');
      s = s.replace(/\d+/g, '');
      try {
        return s.replace(/[^\p{L}\s.'-]/gu, '').slice(0, maxLen);
      } catch (e) {
        return s.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ\s.'-]/g, '').slice(0, maxLen);
      }
    };
    el.addEventListener('input', (ev) => {
      const old = el.value;
      const cleaned = sanitize(old);
      if (old !== cleaned) {
        el.value = cleaned;
        try { el.setSelectionRange(cleaned.length, cleaned.length); } catch(e){}
      }
    });
    el.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text') || '';
      const cleaned = sanitize(text);
      const start = el.selectionStart || el.value.length;
      const before = el.value.slice(0, start);
      const after = el.value.slice(el.selectionEnd || start);
      el.value = (before + cleaned + after).slice(0, maxLen);
      try { el.setSelectionRange((before + cleaned).length, (before + cleaned).length); } catch(e){}
      el.dispatchEvent(new Event('input', { bubbles: true }));
    });
    el.addEventListener('keydown', (e) => {
      const allowedKeys = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End','Enter'];
      if (allowedKeys.includes(e.key)) return;
      if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','A','C','V','X'].includes(e.key)) return;
      if (/^[0-9]$/.test(e.key)) e.preventDefault();
      if (/[`~@#$%^&*()_=+\[\]{};:"\\|<>\/?]/.test(e.key)) e.preventDefault();
    });
  }

  function hasInvalidNameChars(s) {
    if (!s) return true;
    s = String(s).normalize('NFKC').trim();
    if (/\d/.test(s)) return true;
    try {
      return /[^\p{L}\s.'-]/u.test(s);
    } catch (e) {
      return /[^A-Za-zÀ-ÖØ-öø-ÿ\s.'-]/.test(s);
    }
  }
  onlyLettersInput(companyNameInput, 80);
  onlyLettersInput(quickName, 60);
  onlyLettersInput(modalName, 60);

  // ---------- Capitalização com exceções (preserva caret corretamente) ----------
const SMALL_WORDS = new Set(['da','de','do','das','dos','e']);

function capitalizePart(part) {
  if (!part) return '';
  return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
}

function toTitleCaseName(str) {
  if (!str) return '';
  // normaliza espaços e diacríticos, mas não remove acentos (preserva)
  const s = String(str).normalize('NFKC').replace(/\u00A0/g, ' ');
  // dividimos preservando espaços para poder calcular caret corretamente
  const tokens = s.split(/(\s+)/); // tokens incluem espaços
  // mapear cada token que não for espaço
  let wordIndex = 0;
  const out = tokens.map(token => {
    if (/^\s+$/.test(token)) return token; // preserva espaços exatamente
    // token é uma "palavra" possivelmente com hífen/apóstrofo
    // tratar subpartes como "anna-maria" => ["anna","-","maria"]
    const parts = token.split(/([-\u2019'])/); // inclui hífen e apóstrofo como tokens
    const newParts = parts.map(p => {
      if (/^[-\u2019']$/.test(p)) return p;
      const norm = p.trim();
      if (!norm) return p;
      const low = norm.toLowerCase();
      // decide se é small word (aplica minúsculas no meio)
      if (SMALL_WORDS.has(low) && wordIndex > 0) {
        // small word e não é a primeira palavra: deixa minúscula
        return low;
      }
      // senão, capitaliza a parte
      return capitalizePart(norm);
    });
    wordIndex++;
    return newParts.join('');
  });
  return out.join('');
}

function applyNameTitleCaseInput(el) {
  if (!el) return;
  let composing = false;

  el.addEventListener('compositionstart', () => composing = true);
  el.addEventListener('compositionend', () => {
    composing = false;
    formatAndPreserveCaret();
  });

  function formatAndPreserveCaret() {
    if (composing) return;
    const old = el.value;
    // guarda start/end atuais
    const selStart = el.selectionStart || 0;
    const selEnd = el.selectionEnd || 0;
    // prefixos/sufixos para calcular posição após transformação
    const before = old.slice(0, selStart);
    const selection = old.slice(selStart, selEnd);
    const after = old.slice(selEnd);

    const newBefore = toTitleCaseName(before);
    const newSelection = toTitleCaseName(selection);
    const transformed = toTitleCaseName(old);

    // coloca valor transformado
    if (transformed !== old) {
      el.value = transformed;
      // calcula novos índices de seleção com base no comprimento do prefixo transformado
      const newStart = newBefore.length;
      const newEnd = newStart + newSelection.length;
      try { el.setSelectionRange(newStart, newEnd); } catch(e){ /* ignore */ }
    }
  }

  el.addEventListener('input', () => {
    formatAndPreserveCaret();
  });

  // paste: insere conteúdo formatado e posiciona caret no fim do inserido
  el.addEventListener('paste', (e) => {
    e.preventDefault();
    const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
    const cleaned = toTitleCaseName(pasted);
    const start = el.selectionStart || el.value.length;
    const before = el.value.slice(0, start);
    const after = el.value.slice(el.selectionEnd || start);
    el.value = before + cleaned + after;
    const pos = (before + cleaned).length;
    try { el.setSelectionRange(pos, pos); } catch(e){ }
    el.dispatchEvent(new Event('input', { bubbles:true }));
  });

  // formata também ao perder foco (garante padronização)
  el.addEventListener('blur', () => {
    const v = el.value;
    const t = toTitleCaseName(v);
    if (t !== v) el.value = t;
  });
}

// aplica aos campos de nome rápidos e modal
applyNameTitleCaseInput(quickName);
applyNameTitleCaseInput(modalName);


  // Motivo sanitization
  function sanitizeMotivo(s, maxLen = 120) {
    s = String(s || '').normalize('NFKC');
    try {
      return s.replace(/[^\p{L}\p{N}\s.\-\/,():º%]/gu, '').slice(0, maxLen);
    } catch (e) {
      return s.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ0-9\s.\-\/,():º%]/g, '').slice(0, maxLen);
    }
  }
  function onlyMotivoInput(el, maxLen = 120) {
  if (!el) return;

  // helper: índice da primeira letra unicode (fallback se não suportar \p{L})
  function indexOfFirstLetter(s) {
    try {
      return s.search(/\p{L}/u);
    } catch (e) {
      return s.search(/[A-Za-zÀ-ÖØ-öø-ÿ]/);
    }
  }

  // capitaliza a primeira letra encontrada de uma string (preserva resto)
  function capitalizeFirstAlpha(str) {
    if (!str) return str;
    const idx = indexOfFirstLetter(str);
    if (idx === -1) return str;
    return str.slice(0, idx) + str.charAt(idx).toUpperCase() + str.slice(idx + 1);
  }

  // capitaliza a primeira letra de cada "palavra", preservando espaços, hífens e apóstrofos
  function capitalizeWordsPreserve(s) {
    if (!s) return s;
    // normalize para evitar problemas com composições estranhas
    const normalized = String(s).normalize('NFKC').replace(/\u00A0/g, ' ');
    // split preservando espaços
    const tokens = normalized.split(/(\s+)/);
    return tokens.map(token => {
      if (/^\s+$/.test(token)) return token;
      // dividir por hífen/apóstrofo para capitalizar partes como "anna-maria" corretamente
      const parts = token.split(/([-\u2019'])/);
      return parts.map(p => {
        if (/^[-\u2019']$/.test(p)) return p;
        return capitalizeFirstAlpha(p);
      }).join('');
    }).join('');
  }

  let composing = false;
  el.addEventListener('compositionstart', () => composing = true);
  el.addEventListener('compositionend', () => {
    composing = false;
    formatAndPreserveCaret();
  });

  function formatAndPreserveCaret() {
    if (composing) return;
    const old = el.value || '';
    const selStart = el.selectionStart || 0;
    const selEnd = el.selectionEnd || 0;

    const before = old.slice(0, selStart);
    const selection = old.slice(selStart, selEnd);
    const after = old.slice(selEnd);

    // sanitize as partes individualmente (mantendo comportamento anterior)
    const cleanedBefore = sanitizeMotivo(before, maxLen);
    const cleanedSelection = sanitizeMotivo(selection, maxLen);
    const cleanedAfter = sanitizeMotivo(after, maxLen);

    // recombina (limite de tamanho)
    const combined = (cleanedBefore + cleanedSelection + cleanedAfter).slice(0, maxLen);

    // transforma: capitaliza 1ª letra de cada palavra
    const transformed = capitalizeWordsPreserve(combined);

    if (transformed !== old) {
      el.value = transformed;
      // calcula novo start/end baseando-se nas transformações das partes
      const newBefore = capitalizeWordsPreserve(cleanedBefore);
      const newSelection = capitalizeWordsPreserve(cleanedSelection);
      const newStart = newBefore.length;
      const newEnd = newStart + newSelection.length;
      try { el.setSelectionRange(newStart, newEnd); } catch (e) { /* ignore */ }
    }
  }

  el.addEventListener('input', () => {
    formatAndPreserveCaret();
  });

  // paste: insere conteúdo formatado e posiciona caret no fim do inserido
  el.addEventListener('paste', (e) => {
    e.preventDefault();
    const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
    const cleaned = sanitizeMotivo(pasted, maxLen);
    const transformed = capitalizeWordsPreserve(cleaned);
    const start = el.selectionStart || el.value.length;
    const before = el.value.slice(0, start);
    const after = el.value.slice(el.selectionEnd || start);
    // aplica sanitize nas outras partes também para manter consistência
    const newBefore = sanitizeMotivo(before, maxLen);
    const newAfter = sanitizeMotivo(after, maxLen);
    const combined = (newBefore + transformed + newAfter).slice(0, maxLen);
    el.value = capitalizeWordsPreserve(combined);
    const pos = (newBefore + transformed).length;
    try { el.setSelectionRange(pos, pos); } catch (e) { /* ignore */ }
    el.dispatchEvent(new Event('input', { bubbles: true }));
  });

  // mantém a mesma regra de teclas permitidas que você já tinha
  el.addEventListener('keydown', (e) => {
    const allowedKeys = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End','Enter',' '];
    if (allowedKeys.includes(e.key)) return;
    if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','A','C','V','X'].includes(e.key)) return;
    if (/[^0-9a-zA-Z\s.\-\/,():º%çÇáéíóúàèìòùâêîôûãõÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕ!?"'@#\$%\^&\*\+=\[\]{}\\|<>`~]/.test(e.key)) {
      e.preventDefault();
    }
  });

  // blur: garante capitalização final e sanitize
  el.addEventListener('blur', () => {
    const cleaned = sanitizeMotivo(el.value, maxLen);
    el.value = capitalizeWordsPreserve(cleaned);
  });
}

  onlyMotivoInput(quickMotivo, 100);
  onlyMotivoInput(modalMotivo, 100);

  // ------------------ persist select choice ------------------
  if (quickDia) quickDia.addEventListener('change', () => {
    try { sessionStorage.setItem('he_sub_dia', quickDia.value); } catch(e){}
  });
  if (modalDia) modalDia.addEventListener('change', () => {
    try { sessionStorage.setItem('he_sub_dia', modalDia.value); } catch(e){}
  });

  // ---------- MODAL HANDLERS ----------
  function openModal(){
    editingIndex = null;
    const modalTitle = document.getElementById('modalTitle');
    if (modalTitle) modalTitle.textContent = 'Adicionar Membro';
    if (modalSave) modalSave.textContent = 'Adicionar';
    if (modalDia) modalDia.removeAttribute('disabled');

    modalBack.style.display = 'flex';
    modalBack.setAttribute('aria-hidden','false');
    modalName.focus();
    modalName.value = '';
    modalMotivo.value = '';
    modalOT.value = '';
    clearFieldError(modalName); clearFieldError(modalOT); clearFieldError(modalMotivo);
  }

  function closeModal(){
    editingIndex = null;
    modalBack.style.display = 'none';
    modalBack.setAttribute('aria-hidden','true');
    modalName.value = '';
    modalMotivo.value = '';
    modalOT.value = '';
    const modalTitle = document.getElementById('modalTitle');
    if (modalTitle) modalTitle.textContent = 'Adicionar Membro';
    if (modalSave) modalSave.textContent = 'Adicionar';
    if (modalDia) modalDia.removeAttribute('disabled');
  }

  function openEditModal(index){
    if (typeof index !== 'number' || index < 0 || index >= members.length) return;
    editingIndex = index;
    const m = members[index] || {};
    const modalTitle = document.getElementById('modalTitle');
    if (modalTitle) modalTitle.textContent = 'Editar Membro';
    if (modalSave) modalSave.textContent = 'Salvar';
    modalName.value = m.name || '';
    modalOT.value = m.ot || '';
    modalMotivo.value = m.motivo || '';
    if (modalDia) modalDia.setAttribute('disabled','true');

    modalBack.style.display = 'flex';
    modalBack.setAttribute('aria-hidden','false');
    modalName.focus();
  }

  btnAddMember.addEventListener('click', openModal);
  modalCancel.addEventListener('click', closeModal);
  modalBack.addEventListener('click', (e)=>{ if(e.target === modalBack) closeModal(); });

  modalSave.addEventListener('click', ()=>{
  const name = modalName.value.trim();
  const ot = modalOT.value.trim();
  const motivo = modalMotivo.value.trim();

  if (editingIndex !== null) {
    // Validações básicas
    if(!name){ showNotification('Nome é obrigatório.','warning'); showFieldError(modalName,'Nome é obrigatório.'); return; }
    if (hasInvalidNameChars(name)){ showNotification('Nome do colaborador contém números ou caracteres inválidos.','warning'); showFieldError(modalName,'Nome inválido.'); return; }
    if(!ot || !/^\d+$/.test(ot)){ showNotification('OT (Embarcação) é obrigatório e deve conter apenas números.','warning'); showFieldError(modalOT,'OT inválido.'); return; }
    if(!motivo){ showNotification('Motivo é obrigatório.','warning'); showFieldError(modalMotivo,'Motivo é obrigatório.'); return; }

    // --- Verificações de duplicata ao editar (não comparar com o próprio índice) ---
    const normEdited = normalizeName(name);
    const duplicateIndex = members.findIndex((m,i) => normalizeName(m.name) === normEdited && i !== editingIndex);
    if (duplicateIndex !== -1) {
      showNotification('Colaborador já foi adicionado. Por favor inclua o sobrenome para diferenciar.','warning');
      showFieldError(modalName, 'Nome duplicado.');
      return;
    }

    const words = name.split(/\s+/).filter(Boolean);
    if (words.length === 1) {
      const first = normEdited;
      const conflictFirst = members.some((m,i) => i !== editingIndex && normalizeName(m.name).split(' ')[0] === first);
      if (conflictFirst) {
        showNotification('Já existe colaborador com esse primeiro nome — adicione o sobrenome.','warning');
        showFieldError(modalName, 'Adicione o sobrenome.');
        return;
      }
    }

    // Atualiza o membro
    members[editingIndex].name = name;
    members[editingIndex].ot = ot;
    members[editingIndex].motivo = motivo;

    try{ sessionStorage.setItem('he_sub_members', JSON.stringify(members)); }catch(e){}
    render();
    closeModal();
    showNotification('Registro atualizado.', 'success');
    return;
  }

  // --- fluxos de adicionar (não edição) continuam usando addMember ---
  const diaChoice = (modalDia && modalDia.value) ? modalDia.value : 'hoje';
  const extraDate = computeDateForChoice(diaChoice);
  const res = addMember(name,ot,motivo,extraDate);
  if(!res.ok){ showNotification(res.msg, 'warning'); // highlight relevant fields
    if(/Subcontratada/i.test(res.msg)) showFieldError(companyNameInput, res.msg);
    if(/Nome/i.test(res.msg)) showFieldError(modalName,res.msg);
    if(/OT/i.test(res.msg)) showFieldError(modalOT,res.msg);
    if(/Motivo/i.test(res.msg)) showFieldError(modalMotivo,res.msg);
    return;
  }

  try { sessionStorage.setItem('he_sub_dia', diaChoice); } catch(e){}

  closeModal();
  showNotification('Colaborador adicionado.', 'success');
});


  quickAdd.addEventListener('click', ()=>{
    clearFieldError(companyNameInput); clearFieldError(quickName); clearFieldError(quickOT); clearFieldError(quickMotivo);
    const diaChoice = (quickDia && quickDia.value) ? quickDia.value : 'hoje';
    const extraDate = computeDateForChoice(diaChoice);
    const res = addMember(quickName.value, quickOT.value, quickMotivo.value, extraDate);
    if(!res.ok){
      showNotification(res.msg, 'warning');
      if(/Subcontratada/i.test(res.msg)) showFieldError(companyNameInput, res.msg);
      if(/Nome/i.test(res.msg)) showFieldError(quickName,res.msg);
      if(/OT/i.test(res.msg)) showFieldError(quickOT,res.msg);
      if(/Motivo/i.test(res.msg)) showFieldError(quickMotivo,res.msg);
      return;
    }

    try { sessionStorage.setItem('he_sub_dia', diaChoice); } catch(e){}

    quickName.value = '';
    quickMotivo.value = '';
    quickOT.value = '';
    quickName.focus();
    showNotification('Colaborador adicionado.', 'success');
  });

  quickClear.addEventListener('click', ()=>{ quickName.value=''; quickMotivo.value=''; quickOT.value=''; quickName.focus(); });

  [quickName, quickMotivo, quickOT, companyNameInput].forEach(el=>{
    if(!el) return;
    el.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        if(el === companyNameInput){
          e.preventDefault();
          quickName.focus();
          return;
        }
        e.preventDefault(); quickAdd.click();
      }
    })
  });

  [modalName, modalMotivo, modalOT].forEach(el=>{
    if(!el) return;
    el.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && (el === modalName)){
        e.preventDefault(); modalOT.focus();
      }
    })
  });

  // ---------- PDF GENERATION ----------
  const pdfTemplateUrl = './terceiros.jpg';
  const jspdfLib = window.jspdf;

  async function loadImageAsDataURL(url) {
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const blob = await res.blob();
      return await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    } catch (err) {
      console.warn('loadImageAsDataURL falhou:', err);
      return null;
    }
  }

  // ---------------- (MELHORIA 1) cache do template e pré-load ----------------
  let cachedTemplateData = null;
  (async function preloadPdfTemplate(){
    try {
      cachedTemplateData = await loadImageAsDataURL(pdfTemplateUrl);
      console.debug('Template PDF pré-carregado.');
    } catch (err) {
      console.debug('Pré-load do template falhou:', err);
      cachedTemplateData = null;
    }
  })();

  function formatDateForPdf(isoOrDate){
    if(!isoOrDate) return '-';
    try {
      if(/^\d{4}-\d{2}-\d{2}$/.test(isoOrDate)){
        const [yy,mm,dd] = isoOrDate.split('-').map(Number);
        return `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yy}`;
      }
      const d = new Date(isoOrDate);
      if (Number.isNaN(d.getTime())) return isoOrDate;
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    } catch(e) { return isoOrDate; }
  }

  // ---------- computeTimeRangeFromDate agora retorna {start,end} ou null (corrige horas que não apareciam) ----------
  function computeTimeRangeFromDate(dateStr){
    if(!dateStr) return null;
    let d;
    if(/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
      const [yy,mm,dd] = dateStr.split('-').map(Number);
      d = new Date(yy, mm-1, dd);
    } else {
      d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return null;
    }
    const day = d.getDay(); // 0=Sun,1=Mon,...6=Sat
    if(day >= 1 && day <= 4) return { start: '17:00', end: '18:00' };
    if(day === 5) return { start: '16:00', end: '18:00' };
    if(day === 6) return { start: '07:00', end: '16:00' };
    return null;
  }

  const PDF_COORDS = {
    companyX: 141,
    companyY: 104,
    dateX: 370,
    dateY: 104,
    xHora: 445,
    yHora: 142,
    tableStartY: 142,
    xName: 72,
    xOT: 255,
    xMotivo: 285,
    rightLimit: 540,
    rowHeight: 12,
    topMargin: 48,
    bottomMargin: 72
  };

  // --- Substituída: generatePdfFromMembers usa cache se disponível (MELHORIA 2) ---
  async function generatePdfFromMembers({ company, dateOnly, members, observacoesGerais }) {
    if (!jspdfLib || !jspdfLib.jsPDF) throw new Error('jsPDF não carregado');
    const { jsPDF } = jspdfLib;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    // usa cache se disponível para evitar refetch e reconversão a cada export
    const imgData = cachedTemplateData || await loadImageAsDataURL(pdfTemplateUrl);

    function drawTemplate() {
      if (imgData) {
        try { doc.addImage(imgData, 'JPEG', 0, 0, pageW, pageH); }
        catch (e) { doc.setFillColor(255,255,255); doc.rect(0,0,pageW,pageH,'F'); }
      } else {
        doc.setFillColor(255,255,255); doc.rect(0,0,pageW,pageH,'F');
      }
    }

    const coords = PDF_COORDS;
    const nameMaxWidth = coords.xOT - coords.xName - 8;
    const motivoMaxWidth = Math.max(80, coords.rightLimit - coords.xMotivo - 8);

    function getSingleLineText(text, maxWidth){
      const arr = doc.splitTextToSize(String(text || ''), maxWidth);
      if (!arr.length) return '-';
      let first = arr[0];
      if (arr.length > 1) {
        while (doc.getTextWidth(first + '…') > maxWidth && first.length > 0) first = first.slice(0, -1);
        first = first + '…';
      }
      return first;
    }

    const availableHeight = pageH - coords.tableStartY - coords.bottomMargin;
    const rowsPerPage = Math.floor(availableHeight / coords.rowHeight);
    let pageIndex = 0;
    let idx = 0;

    while (idx < members.length) {
      if (pageIndex > 0) doc.addPage();
      drawTemplate();

      doc.setFont('Helvetica','normal');
      doc.setFontSize(11);
      doc.text(String((company || '-').toLocaleUpperCase('pt-BR')), coords.companyX, coords.companyY);

      doc.setFont('Helvetica','normal');
      doc.setFontSize(11);
      doc.text(String(formatDateForPdf(dateOnly)), coords.dateX, coords.dateY);

      let y = coords.tableStartY;
      for (let r = 0; r < rowsPerPage && idx < members.length; r++, idx++) {
        const m = members[idx];
        const nameText = getSingleLineText(m.name || '-', nameMaxWidth);
        const otText = String(m.ot || '-');
        const motivoText = getSingleLineText(m.motivo || '-', motivoMaxWidth);

        doc.setFontSize(8);
        doc.text(nameText, coords.xName, y);
        doc.text(otText, coords.xOT, y);
        doc.text(motivoText, coords.xMotivo, y);

        // --- desenhar horas em duas colunas para garantir aparecimento ---
        const memberDate = (m && m.extraDate) ? m.extraDate : dateOnly;
        const horario = computeTimeRangeFromDate(memberDate);
        if (horario) {
          // desenha início e término em colunas separadas (ajuste offset segundo template)
          doc.text(horario.start, coords.xHora, y);
          if (horario.end) doc.text(horario.end, coords.xHora + 38, y);
        }

        y += coords.rowHeight;
      }

      pageIndex++;
    }

    if (observacoesGerais) {
      const obsLines = doc.splitTextToSize(String(observacoesGerais), pageW - coords.topMargin*2);
      let obsY = Math.max(coords.tableStartY + rowsPerPage * coords.rowHeight + 10, pageH - coords.bottomMargin - obsLines.length*12 - 10);
      if (obsY + obsLines.length * 12 > pageH - 20) {
        doc.addPage();
        drawTemplate();
        obsY = 80;
      }
      doc.setFontSize(9);
      doc.text('Observações:', coords.topMargin, obsY);
      obsY += 12;
      obsLines.forEach(line => {
        doc.text(line, coords.topMargin, obsY);
        obsY += 12;
      });
    }

    const safeCompany = String(company || 'company').replace(/[^a-z0-9_-]/ig,'').slice(0,30);
    const safeDate = String(dateOnly || localDateToYYYYMMDD(new Date())).replace(/[^0-9_-]/g,'');
    const fileName = `hora_extra_${safeCompany}_${safeDate}.pdf`;

    // Retorna o jsPDF object e o fileName para o chamador decidir salvar ou compartilhar
    return { doc, fileName };
  }

  // --- versão robusta de trySharePdf (faz download forçado via objectURL se necessário) ---
  async function trySharePdf(jsPdfDoc, fileName) {
    // 1) criar Blob de forma tolerante (suporta output('blob'), output('arraybuffer'), ou datauri)
    let blob = null;
    try {
      if (typeof jsPdfDoc.output === 'function') {
        // tentativa direta de blob (padrão moderno)
        try {
          const maybe = jsPdfDoc.output('blob');
          blob = maybe instanceof Promise ? await maybe : maybe;
        } catch (e) {
          // fallback para arraybuffer posteriormente
        }
      }
    } catch (err) {
      console.debug('output("blob") falhou, tentando fallback:', err);
    }

    if (!blob) {
      try {
        // fallback para arraybuffer
        if (typeof jsPdfDoc.output === 'function') {
          const ab = jsPdfDoc.output('arraybuffer');
          const arr = (ab instanceof Promise) ? new Uint8Array(await ab) : new Uint8Array(ab);
          blob = new Blob([arr], { type: 'application/pdf' });
        }
      } catch (err) {
        console.debug('output("arraybuffer") falhou:', err);
      }
    }

    if (!blob) {
      try {
        // fallback extra: datauri string -> converter em Blob
        if (typeof jsPdfDoc.output === 'function') {
          const datauri = jsPdfDoc.output('datauristring');
          if (typeof datauri === 'string' && datauri.indexOf(',') > -1) {
            const base64 = datauri.split(',')[1];
            const binary = atob(base64);
            const len = binary.length;
            const u8 = new Uint8Array(len);
            for (let i = 0; i < len; i++) u8[i] = binary.charCodeAt(i);
            blob = new Blob([u8], { type: 'application/pdf' });
          }
        }
      } catch (err) {
        console.debug('output("datauristring") falhou:', err);
      }
    }

    if (!blob) {
      // se tudo falhar
      throw new Error('Não foi possível gerar o Blob do PDF.');
    }

    // 2) preparar File (usado pelo navigator.share)
    let file;
    try {
      file = new File([blob], fileName, { type: 'application/pdf' });
    } catch (e) {
      file = null;
    }

    // 3) tentar compartilhar (Web Share API nível 2)
    if (file && navigator.canShare && navigator.canShare({ files: [file] }) && typeof navigator.share === 'function') {
      try {
        await navigator.share({
          files: [file],
          title: fileName,
          text: 'Folha de Hora Extra'
        });
        // compartilhou com sucesso — pronto
        return { shared: true, method: 'share' };
      } catch (err) {
        // usuário cancelou ou erro no share — seguimos para o download fallback
        console.debug('navigator.share falhou/cancelado:', err);
      }
    }

    // 4) fallback confiável: forçar download via anchor + objectURL
    try {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = fileName || 'document.pdf';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        try { document.body.removeChild(a); } catch(e){}
        try { URL.revokeObjectURL(url); } catch(e){}
      }, 1000);
      return { shared: false, method: 'download' };
    } catch (err) {
      console.debug('download via anchor/objectURL falhou:', err);
      // último recurso: usar jsPDF.save se disponível
      if (typeof jsPdfDoc.save === 'function') {
        try {
          jsPdfDoc.save(fileName || 'document.pdf');
          return { shared: false, method: 'download-jsPDF' };
        } catch (e) {
          console.debug('jsPdfDoc.save também falhou:', e);
        }
      }
      throw new Error('Falha ao salvar/compartilhar o PDF: ' + (err.message || err));
    }
  }

  // ---------- Attach export button ----------
  // ---------- (MELHORIA 3) UI feedback: spinner + aria-busy ----------
if (btnExport) {
  btnExport.addEventListener('click', async ()=>{
    if(members.length === 0){ showNotification('Nenhum registro para gerar PDF.','warning'); return; }
    if (!window.jspdf || !window.jspdf.jsPDF) {
      showNotification('Biblioteca jsPDF não encontrada. Verifique a inclusão do CDN.', 'error');
      console.error('jsPDF não carregado (window.jspdf):', window.jspdf);
      return;
    }

    const company = getCompanyName() || (document.getElementById('companyName')||{}).value || '';
    const fallbackLocal = localDateToYYYYMMDD(new Date());
    const dateOnly = (members[0] && members[0].extraDate) ? members[0].extraDate : fallbackLocal;
    const observacoesGerais = '';

    const payload = { company, dateOnly, members, observacoesGerais };

    // UX: mostrar feedback imediato
    const originalBtnHTML = btnExport.innerHTML;
    try {
      setExportDisabled(true);
      btnExport.setAttribute('aria-busy','true');
      btnExport.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando...';

      // Gera o jsPDF (não salva aqui)
      const { doc, fileName } = await generatePdfFromMembers(payload);

      // Tenta compartilhar; se não for possível, fará download
      const result = await trySharePdf(doc, fileName);
      if (result.shared) {
        showNotification('Arquivo compartilhado com sucesso.', 'success');
      } else {
        showNotification('PDF gerado e baixado.', 'success');
      }
    } catch (err) {
      console.error(err);
      showNotification('Erro ao gerar/compartilhar PDF: ' + (err.message || err), 'error');
    } finally {
      btnExport.innerHTML = originalBtnHTML;
      btnExport.removeAttribute('aria-busy');
      setExportDisabled(false);
    }
  });
} else {
  // fallback: se o botão original não existir, permita disparar pela custom event
  document.addEventListener('export:trigger', async () => {
    if(members.length === 0){ showNotification('Nenhum registro para gerar PDF.','warning'); return; }
    if (!window.jspdf || !window.jspdf.jsPDF) {
      showNotification('Biblioteca jsPDF não encontrada. Verifique a inclusão do CDN.', 'error');
      console.error('jsPDF não carregado (window.jspdf):', window.jspdf);
      return;
    }

    const company = getCompanyName() || (document.getElementById('companyName')||{}).value || '';
    const fallbackLocal = localDateToYYYYMMDD(new Date());
    const dateOnly = (members[0] && members[0].extraDate) ? members[0].extraDate : fallbackLocal;
    const observacoesGerais = '';

    const payload = { company, dateOnly, members, observacoesGerais };

    // visual feedback: tenta usar btnExportFab se existir, senão nenhum
    const visualBtn = btnExport || btnExportFab || null;
    const originalHTML = visualBtn ? visualBtn.innerHTML : null;
    try {
      setExportDisabled(true);
      if (visualBtn) {
        visualBtn.setAttribute('aria-busy','true');
        visualBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      }

      const { doc, fileName } = await generatePdfFromMembers(payload);
      const result = await trySharePdf(doc, fileName);
      if (result.shared) {
        showNotification('Arquivo compartilhado com sucesso.', 'success');
      } else {
        showNotification('PDF gerado e baixado.', 'success');
      }
    } catch (err) {
      console.error(err);
      showNotification('Erro ao gerar/compartilhar PDF: ' + (err.message || err), 'error');
    } finally {
      if (visualBtn && originalHTML !== null) {
        visualBtn.innerHTML = originalHTML;
        visualBtn.removeAttribute('aria-busy');
      }
      setExportDisabled(false);
    }
  });
}


  // ---------- Clear + hydrate ----------
  btnClear.addEventListener('click', ()=>{
    if(!confirm('Tem certeza que deseja limpar todos os registros desta sessão?')) return;
    members = [];
    sessionStorage.removeItem('he_sub_members');
    render();
  });

  try{
    const prev = sessionStorage.getItem('he_sub_members');
    if(prev){ members = JSON.parse(prev) || []; }
    const savedCompany = sessionStorage.getItem('he_sub_company');
    if(savedCompany) companyNameInput.value = savedCompany;

    try {
      const savedDia = sessionStorage.getItem('he_sub_dia');
      if (savedDia) {
        if (quickDia) quickDia.value = savedDia;
        if (modalDia) modalDia.value = savedDia;
      }
    } catch(e){}
  }catch(e){ members = []; }

  companyNameInput.addEventListener('input', ()=>{
    try{ sessionStorage.setItem('he_sub_company', getCompanyName()); }catch(e){}
    clearFieldError(companyNameInput);
    render();
  });

  render();

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modalBack.style.display === 'flex') closeModal();
  });

  // expose render globally (for external calls)
  window.__heRender = render;

  // ---- composition/uppercase handling for companyName (preserve caret) ----
  let composing = false;
  companyNameInput.addEventListener('compositionstart', ()=> composing = true);
  companyNameInput.addEventListener('compositionend', ()=> {
    composing = false;
    upperCasePreserveCaret(companyNameInput);
  });

  companyNameInput.addEventListener('input', ()=> {
    if (!composing) upperCasePreserveCaret(companyNameInput);
  });

  companyNameInput.addEventListener('paste', (e) => {
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text') || '';
    const cleaned = text.normalize('NFKC').toLocaleUpperCase('pt-BR');
    const start = companyNameInput.selectionStart || companyNameInput.value.length;
    const before = companyNameInput.value.slice(0, start);
    const after = companyNameInput.value.slice(companyNameInput.selectionEnd || start);
    companyNameInput.value = (before + cleaned + after).slice(0, 200);
    const pos = (before + cleaned).length;
    try { companyNameInput.setSelectionRange(pos, pos); } catch(e){}
    sessionStorage.setItem('he_sub_company', companyNameInput.value);
  });

  companyNameInput.addEventListener('blur', ()=> {
    companyNameInput.value = companyNameInput.value.normalize('NFKC').toLocaleUpperCase('pt-BR');
  });

  function upperCasePreserveCaret(el) {
    const start = el.selectionStart;
    const end = el.selectionEnd;
    const val = el.value || '';
    const up = val.normalize('NFKC').toLocaleUpperCase('pt-BR');
    if (val !== up) {
      el.value = up;
      try { el.setSelectionRange(start, end); } catch(e) {}
    }
  }

  // ---------------------- UX helpers (field error, changed, snackbar, export state) ----------------------
  function ensureFieldHelp(el, text){
    if(!el) return;
    let help = el.parentNode.querySelector('.field-help');
    if(!help){
      help = document.createElement('div');
      help.className = 'field-help';
      el.parentNode.appendChild(help);
    }
    if(text) help.textContent = text;
    return help;
  }

  function showFieldError(el, msg){
    if(!el) return;
    el.classList.add('field-error');
    el.setAttribute('aria-invalid','true');
    const help = ensureFieldHelp(el);
    help.classList.add('error');
    help.textContent = msg;
    try{ el.focus(); }catch(e){}
  }
  function clearFieldError(el){
    if(!el) return;
    el.classList.remove('field-error');
    el.removeAttribute('aria-invalid');
    const help = el.parentNode.querySelector('.field-help');
    if(help){ help.classList.remove('error'); help.textContent = ''; }
  }

  function setOriginalValue(el) { if(!el) return; el.dataset.original = el.value || ''; }
  function watchChanged(el){
    if(!el) return;
    setOriginalValue(el);
    el.addEventListener('input', ()=> {
      if(el.value !== (el.dataset.original||'')) el.classList.add('field-changed');
      else el.classList.remove('field-changed');
    });
  }
  [companyNameInput, quickName, quickOT, quickMotivo, modalName, modalOT, modalMotivo].forEach(el => { watchChanged(el); });

  function setExportDisabled(state){
  // state = true -> desabilita; false -> habilita
  if (btnExport) {
    if (state) {
      btnExport.setAttribute('disabled','true');
      btnExport.setAttribute('aria-disabled','true');
    } else {
      btnExport.removeAttribute('disabled');
      btnExport.removeAttribute('aria-disabled');
    }
  }
  if (btnExportFab) {
    if (state) {
      btnExportFab.setAttribute('disabled','true');
      btnExportFab.setAttribute('aria-disabled','true');
    } else {
      btnExportFab.removeAttribute('disabled');
      btnExportFab.removeAttribute('aria-disabled');
    }
  }
}

function refreshExportState(){
  const hasMembers = members && members.length;
  const hasCompany = (companyNameInput && companyNameInput.value.trim());
  const shouldDisable = !hasMembers || !hasCompany;
  setExportDisabled(shouldDisable);
}


  refreshExportState();

  // Snackbar with undo
  function showSnackbar(msg, undoCb){
    const bar = document.getElementById('snackbar');
    if(!bar) return;
    bar.innerHTML = `<div style="min-width:180px">${msg}</div><div style="flex:0 0 auto"><button id="snackUndo">Desfazer</button></div>`;
    bar.style.display = 'flex';
    setTimeout(()=> bar.classList.add('show'), 10);
    const undoBtn = document.getElementById('snackUndo');
    let timedOut = false;
    const t = setTimeout(()=> {
      bar.classList.remove('show');
      setTimeout(()=> { bar.style.display='none'; if(typeof undoCb === 'function') undoCb(false); }, 300);
      timedOut = true;
    }, 6000);

    undoBtn.addEventListener('click', ()=>{
      if(timedOut) return;
      clearTimeout(t);
      bar.classList.remove('show');
      setTimeout(()=> { bar.style.display='none'; if(typeof undoCb === 'function') undoCb(true); }, 200);
    }, { once: true });
  }

})(); // end iife

// ---------- Notifications & helpers (outside IIFE) ----------
function showNotification(message, type = "info") {
  // tenta fechar o teclado móvel: blur do elemento ativo e garantir foco no body
  try {
    const ae = document.activeElement;
    if (ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.tagName === 'SELECT' || ae.isContentEditable)) {
      ae.blur();
      // alguns browsers (iOS) precisam de um pequeno delay para realmente esconder o teclado
      setTimeout(() => {
        try { if (document.body && typeof document.body.focus === 'function') document.body.focus(); } catch(e){}
      }, 50);
    }
  } catch(e) {
    // não quebra se algo der errado
    console.debug('hideKeyboard failed', e);
  }

  const modal = document.getElementById("notificationModal");
  if (!modal) { alert(message); return; }

  let msg = document.getElementById("notificationMessage");
  if (!msg) {
    msg = document.createElement('p');
    msg.id = 'notificationMessage';
    msg.style.display = 'flex';
    msg.style.alignItems = 'center';
    msg.style.gap = '10px';
    const content = modal.querySelector('.notification-content');
    if (content) content.insertBefore(msg, content.firstChild);
  }

  const iconClass = {
    success: 'fas fa-check-circle',
    error: 'fas fa-times-circle',
    warning: 'fas fa-exclamation-triangle',
    info: 'fas fa-info-circle',
  };

  const iconWrapper = document.createElement('div');
  iconWrapper.className = `notification-icon ${type}`;
  const iconEl = document.createElement('i');
  iconEl.className = iconClass[type] || iconClass.info;
  iconWrapper.appendChild(iconEl);

  let textEl = document.getElementById('notificationText');
  if (!textEl) {
    textEl = document.createElement('div');
    textEl.id = 'notificationText';
    textEl.className = 'notification-text';
  }
  textEl.textContent = message;

  msg.innerHTML = '';
  msg.appendChild(iconWrapper);
  msg.appendChild(textEl);

  let okBtn = document.getElementById("notificationOkBtn");
  if (!okBtn) {
    const btn = document.createElement('button');
    btn.id = 'notificationOkBtn';
    btn.textContent = 'OK';
    const content = modal.querySelector('.notification-content');
    if (content) content.appendChild(btn);
    okBtn = document.getElementById("notificationOkBtn");
  }

  // mostra modal
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("show"), 10);

  // reattach listener de forma segura (clona para remover handlers antigos)
  okBtn.replaceWith(okBtn.cloneNode(true));
  okBtn = document.getElementById("notificationOkBtn");
  okBtn.addEventListener('click', closeNotification);

  // garantir que o foco vá para o botão OK — foco em botão não reabre teclado
  try { okBtn.focus(); } catch(e){}
}


function closeNotification() {
  const modal = document.getElementById("notificationModal");
  if (!modal) return;
  modal.classList.remove("show");
  setTimeout(() => {
    modal.style.display = "none";
  }, 300);
}

function setupModalHandlers() {
  const notificationModal = document.getElementById("notificationModal");
  if (notificationModal) {
    notificationModal.addEventListener("click", (e) => {
      if (e.target === notificationModal) closeNotification();
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      const notificationModal = document.getElementById("notificationModal");
      if (notificationModal && notificationModal.style.display === "flex") {
        closeNotification();
        return;
      }
      const modalBack = document.getElementById('modalBack');
      if (modalBack && modalBack.style.display === 'flex') {
        modalBack.style.display = 'none';
        modalBack.setAttribute('aria-hidden','true');
      }
    }
  });
}
</script>

</body>
</html>

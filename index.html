<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<title>Hora Extra | Subcontratada</title>
<link rel="icon" type="image/png" href="../favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg" />
<link rel="shortcut icon" href="../favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png" />
<link rel="manifest" href="../favicon/site.webmanifest" />
<!-- jsPDF (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root {
    --bg: #0b0c0f;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --accent: #9fccb1;
    --accent-strong: #3b82f6;
    --secondary: #39666b;
    --text: #e1efe6;
    --muted: rgba(225,239,230,0.68);
    --muted-2: rgba(225,239,230,0.48);
    --neumo-shadow: 0 8px 20px rgba(0,0,0,0.45);
    --radius: 14px;
    --max-width: 1200px;
    --gap: 18px;
    --btn-grad: linear-gradient(135deg,#4f46e5,#7c3aed);
    --btn-glow-grad: linear-gradient(135deg, rgba(79,70,229,0.28), rgba(124,58,237,0.28));
    --cta-contrast: #ffffff;
    --hover-ease: cubic-bezier(.15,.9,.25,1);
    --danger: #ef4444;
    --warning: #f59e0b;
    --success: #10b981;
    --sidebar-w: 260px;
    --soft-border: rgba(255,255,255,0.08);
    --input-bg: rgba(255,255,255,0.02);
    --input-border: rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(57,102,107,0.08), transparent), var(--bg);
    color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding:32px; display:flex; align-items:flex-start; justify-content:center;
  }
  .wrap{width:100%;max-width:var(--max-width);}

  /* Header */
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:grid;place-items:center;border:1px solid var(--soft-border);box-shadow:var(--neumo-shadow);}
  .logo img{width:28px;height:28px}
  h1{font-size:18px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  /* layout */
  .grid{display:grid;grid-template-columns:1fr 380px;gap:var(--gap)}
  @media (max-width:980px){.grid{grid-template-columns:1fr;gap:14px} .notification-content button {
        width: 100%;
        padding: 12px;
        font-size: 16px;
      }}

  /* main card */
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.018), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;border:1px solid var(--soft-border);box-shadow:var(--neumo-shadow)}

  /* controls */
  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    border:0;
    padding:10px 14px;
    border-radius:10px;
    background: var(--btn-grad);
    color: var(--cta-contrast);
    font-weight:600;
    cursor:pointer;
    position:relative;
    z-index:0;
    transition:transform .12s var(--hover-ease), box-shadow .12s var(--hover-ease);
    box-shadow: 0 8px 24px rgba(59,40,179,0.18);
    overflow:visible;
  }
  .btn::after{
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    z-index: -1;
    background: var(--btn-glow-grad);
    filter: blur(14px);
    opacity: 0;
    transition: opacity .18s ease;
  }
  .btn:hover{ transform: translateY(-4px); }
  .btn:hover::after{ opacity:1; }
  .btn.secondary{ background: transparent; border: 1px solid var(--soft-border); color: var(--muted); box-shadow:none; }
  .btn.ghost{ background: transparent; border: 1px dashed var(--input-border); color: var(--muted); }
  .btn i{ width:18px; text-align:center; font-size:14px; display:inline-block; }

  .btn.secondary::after,
.btn.ghost::after,
.btn--clear::after,
.btn--export::after {
  display: none !important;
  opacity: 0 !important;
}

.btn.secondary,
.btn.ghost,
.btn--clear {
  box-shadow: none !important;
}

.btn--export {
  --shadow: 79,70,229;
  background: linear-gradient(180deg, rgba(var(--shadow),0.06), rgba(124,58,237,0.06));
  color: var(--cta-contrast);
  border: 1px solid rgba(124,58,237,0.18);
  transition: transform .14s var(--hover-ease), background .12s ease;
}
.btn--export:hover{
  transform: translateY(-3px);
}

/* ---------------- Clear (vermelho) ---------------- */
.btn--clear {
  --shadow: 239,68,68;
  background: linear-gradient(180deg, rgba(var(--shadow),0.04), rgba(var(--shadow),0.02));
  color: var(--danger);
  border: 1px solid rgba(var(--shadow),0.12);

  box-shadow: 0 4px 12px rgba(var(--shadow), 0.06);
  transition: transform .14s var(--hover-ease), background .12s ease;
}
.btn--clear:hover{
  transform: translateY(-3px);
}

  /* list */
  .list{margin-top:14px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .list header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
  .list header .title{font-weight:700}
  .table-wrap{overflow:auto;width:100%} /* permite rolagem horizontal em telas pequenas */
  .list table{width:100%;border-collapse:collapse;min-width:920px} /* aumentei um pouco para a nova coluna */
  .list thead th{font-size:12px;text-align:left;padding:12px 14px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.02)}
  .list thead th:nth-child(2){padding: 0px 25px;}
  .list tbody tr{background:linear-gradient(180deg, var(--card), transparent)}
  .list tbody td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:14px;vertical-align:middle}
  .muted{color:var(--muted)}

  /* small pill */
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px;border:1px solid rgba(255,255,255,0.02); color:var(--text)}

  /* sidebar form */
  .side{position:relative}
  .controls-block{display:flex;flex-direction:column;gap:12px}
  label{font-size:13px;color:var(--muted);display:block}
  input[type=text], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;font-size:14px}
  textarea{min-height:90px;resize:none}
  .small-muted{font-size:12px;color:var(--muted)}

  /* sticky behavior only on larger screens */
  .side .sticky{position:sticky;top:18px}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,4,4,0.6);z-index:60}
  .modal-window{width:100%;max-width:520px;background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--soft-border);}

  @media (max-width: 1000px) {
  .modal-window {
    background: rgba(11,12,15,0.98) !important;
    box-shadow: 0 18px 46px rgba(0,0,0,0.65) !important;
    border: 1px solid rgba(255,255,255,0.03) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
}

  .row{display:flex;gap:10px}
  .row .col{flex:1}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* empty state */
  .empty{padding:28px;text-align:center;color:var(--muted);}

  /* tiny helpers */
  .icon-btn{background:transparent;border:0;color:var(--muted);padding:6px;border-radius:8px}
  .remove{color:var(--danger);font-weight:700}
  .time{font-size:12px;color:var(--muted-2)}
  .icon-btn i{
    color: #ff746c;
    transition: all 0.2s;
    cursor:pointer;
  }
  .icon-btn i:hover{
    color: red;
  }

  /* animation */
  .fade-in{animation:fadeIn .18s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* ----------------- MOBILE ADJUSTMENTS ----------------- */
  @media (max-width:980px){
    body{padding:16px; background: radial-gradient(600px 300px at 10% 10%, rgba(57,102,107,0.04), transparent), var(--bg);}
    .wrap{max-width:980px}
    .topbar{flex-direction:column;align-items:flex-start;gap:10px}
    .controls{width:100%;display:flex;gap:8px;flex-wrap:wrap}
    .controls .btn{flex:1;min-width:120px}
    .card{padding:14px}
    .list header{padding:10px}
    .list thead th, .list tbody td{padding:9px}
    .pill{font-size:11px;padding:5px 7px}
    .logo{width:38px;height:38px}
    .logo img{width:22px;height:22px}

    /* Disable sticky behavior on small screens so summary doesn't 'subir junto' */
    .side .sticky{position:static;top:auto}
    /* Ensure aside content flows naturally under main */
    .side{order:2}
    main{order:1}

    /* make the instruction card compact */
    #instructionsCard{margin-top:10px;padding:10px}
    /* reduce table min width for smaller devices */
    .list table{min-width:720px}
  }

  /* Responsive table -> stacked cards on narrow screens */
  @media (max-width:640px){
    .table-wrap{overflow:visible} /* allow stacked flow */
    .list table{min-width:0;border:0}
    .list thead{display:none}
    .list tbody tr{display:block;margin-bottom:10px;padding:12px;border-radius:10px;background:var(--card);border:1px solid rgba(255,255,255,0.02)}
    .list tbody td{display:flex;justify-content:space-between;padding:8px 0;border-bottom:0}
    .list tbody td + td{margin-top:6px}
    .list tbody td:before{content:attr(data-label);display:inline-block;color:var(--muted);margin-right:10px;font-size:13px;min-width:96px}
    .list tbody td .pill{padding:4px 7px;font-size:12px}
    .list tbody td .icon-btn{padding:6px}
    .list tbody td .time{font-size:12px;color:var(--muted-2)}
  }

  /* very small screens tweaks */
  @media (max-width:420px){
    .btn{padding:9px 10px;font-size:13px}
    .btn i{width:16px}
    .logo{width:34px;height:34px}
  }

  .side .sticky{position:static;top:auto}

  /* ===== SCROLLBAR STYLING ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(159, 204, 177, 0.3);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(159, 204, 177, 0.5);
    }

    /* ===== MODAL STYLING ===== */
    .notification-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: modalFadeIn 0.3s var(--hover-ease);
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .notification-content {
      background: linear-gradient(180deg, rgba(11,12,15,0.95), rgba(16,18,17,0.98));
      border: 1px solid rgba(110,116,120,0.10);
      padding: 28px 32px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      animation: modalSlideIn 0.4s var(--hover-ease);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .notification-content p {
      margin-bottom: 20px;
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
      font-weight: 400;
    }

    /* ===== NOTIFICATION ICONS ===== */
    #notificationMessage {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  text-align: center;
}

    /* floating modal notification */
    .notification-modal{ 
  position: fixed; 
  inset: 0; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  background: rgba(0,0,0,0.7); 
  backdrop-filter: blur(4px);
  z-index: 600;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  will-change: transform;
}
.notification-modal.show {
  opacity: 1;
  visibility: visible;
}

    .notification-content{
  background: rgba(11, 12, 15, 0.95);
  backdrop-filter: blur(20px) saturate(130%);
  padding: 20px 28px;
  border-radius: 16px;
  max-width: 420px;
  width: 92%;
  border: 1px solid rgba(255,255,255,0.12);
 box-shadow: 0 8px 20px rgba(0,0,0,0.45);
  color: var(--text);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  transform: scale(0.9) translateY(20px);
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.notification-modal.show .notification-content {
  transform: scale(1) translateY(0);
}

    .notification-content button{
  margin-top: 20px;
  display: inline-block;
  border-radius: 12px;
  padding: 12px 24px;
  border: 1px solid rgba(255,255,255,0.08);
  cursor: pointer;
  background: var(--btn-grad);
  color: white;
  font-weight: 700;
  transition: all 0.3s ease;
  font-size: 14px;
  filter: drop-shadow(0 0 20px rgba(79, 70, 229, 0.4)) drop-shadow(0 0 40px rgba(79, 70, 229, 0.2));
}

/* Estilos para os ícones das notificações */
.notification-icon {
  font-size: 45px;
  margin-bottom: 8px;
  position: relative;
  display: block;
  text-align: center;
  width: 100%;
}

.notification-icon.success {
  color: #28a745;
  filter: drop-shadow(0 0 20px rgba(40, 167, 69, 0.4)) drop-shadow(0 0 40px rgba(40, 167, 69, 0.2));
}

.notification-icon.error {
  color: #dc3545;
  filter: drop-shadow(0 0 20px rgba(220, 53, 69, 0.4)) drop-shadow(0 0 40px rgba(220, 53, 69, 0.2));
}

.notification-icon.warning {
  color: #ffc107;
  filter: drop-shadow(0 0 20px rgba(255, 193, 7, 0.4)) drop-shadow(0 0 40px rgba(255, 193, 7, 0.2));
}

.notification-icon.info {
  color: #2196f3;
  filter: drop-shadow(0 0 20px rgba(33, 150, 243, 0.4)) drop-shadow(0 0 40px rgba(33, 150, 243, 0.2));
}

.notification-text {
  font-size: 16px;
  line-height: 1.5;
  color: var(--text);
  margin: 0;
  text-align: center;
}

@media (max-width: 600px), (max-device-width: 800px) {
  .notification-modal{ background: rgba(0,0,0,0.55); }
}

/* ===== SELECT STYLING ===== */
    select, .select-like{
  background-color: var(--input-bg) !important; color:var(--text) !important; border:1px solid var(--input-border) !important;
  -webkit-appearance:none; -moz-appearance:none; appearance:none; padding-right:35px !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23e1efe6' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") !important;
  background-repeat:no-repeat !important; background-position:right 12px center !important; background-size:16px 16px !important;
}
select option{ background-color:var(--bg) !important; color:var(--text) !important; }
select option:hover, select option:checked{ background:var(--accent) !important; color:#0b150f !important; }
select option[disabled]{ color:var(--muted) !important; }

/* ===== AUTOFILL DARK ===== */
   input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill{
  -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
  box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
  -webkit-text-fill-color: var(--text) !important;
  transition: background-color 5000s ease-in-out 0s !important;
}
input:-webkit-autofill:focus{ -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important; }

/* aplica somente em dispositivos touch, assim não quebra foco de teclado no desktop */
@media (hover: none) and (pointer: coarse) {
  a, button, input, textarea {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }
}

  .dev-note {
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding:12px 10px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow: var(--neumo-shadow);
    }
    .dev-note strong { color:var(--text); letter-spacing:0.01em; font-weight:700; }
    .dev-note .meta { display:block; margin-top:6px; color: rgba(225,239,230,0.45); font-size:11px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="./favicon/favicon.svg" alt="" style="width: 55%;">
        </div>
        <div>
          <h1>Hora Extra | Subcontratada</h1>
          <p class="lead">Registre rapidamente Nome, Subcontratada (preencha uma vez), OT e Motivo.</p>
        </div>
      </div>
      <div class="controls">
        <button id="btnAddMember" class="btn"><i class="fa-solid fa-user-plus"></i> Adicionar Membro</button>
        <button id="btnExport" class="btn btn--export"><i class="fa-solid fa-download"></i></i> Exportar</button>
<button id="btnClear" class="btn btn--clear"><i class="fa-solid fa-trash"></i> Limpar</button>

      </div>
    </div>

    <div class="grid">
      <main class="card" id="mainCard">
        <div class="list fade-in">
          <header>
            <div class="title">Lista de Horas Extras <span id="countPill" class="pill">0</span></div>
            <div class="time" id="lastUpdate">—</div>
          </header>

          <div id="tableWrap" class="table-wrap">
            <table id="membersTable" aria-live="polite">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>OT</th>
                  <th>Subcontratada</th>
                  <th>Motivo</th>
                  <th>Dia HE</th>
                  <th>Adicionado</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <!-- rows -->
              </tbody>
            </table>
          </div>

          <div id="emptyState" class="empty">Nenhum registro ainda. Clique em "Adicionar Membro" para começar.</div>
        </div>
      </main>

      <aside class="side">
        <!-- sticky class aplicado só em telas maiores via CSS; em mobile ele fica estático -->
        <div class="card sticky">
          <h3 style="margin-top:0;margin-bottom:8px">Adicionar rapidamente</h3>
          <div class="controls-block">
            <label for="companyName">Subcontratada (preencha apenas uma vez)</label>
            <input id="companyName" type="text" placeholder="Nome da Subcontratada (ex: Empresa X)" />

            <label for="quickName">Nome</label>
            <input id="quickName" type="text" autocomplete="off" placeholder="Nome do colaborador" />

            <label for="quickOT">OT (Embarcação)</label>
            <input id="quickOT" type="text" inputmode="numeric" pattern="\d*" maxlength="6" placeholder="Ex: 430" autocomplete="off" aria-label="OT (somente números)" />

            <label for="quickMotivo">Motivo <span class="small-muted">(ex: Bloco D1)</span></label>
            <input id="quickMotivo" type="text" autocomplete="off" maxlength="100" placeholder="Ex: Bloco D1" />

            <label for="quickDia">Dia da hora extra</label>
            <select id="quickDia" aria-label="Dia da hora extra">
              <option value="hoje" selected>Hoje</option>
              <option value="sabado">Sábado (próximo)</option>
            </select>

            <div style="display:flex;gap:8px">
              <button id="quickAdd" class="btn" style="flex:1"><i class="fa-solid fa-user-plus"></i>Adicionar</button>
              <button id="quickClear" class="btn secondary" style="flex:1"><i class="fa-solid fa-trash"></i>Limpar campos</button>
            </div>
            <p class="small-muted" style="margin-top:8px">Dica: pressione Enter em qualquer campo para adicionar.</p>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card" id="summaryCard">
          <h4 style="margin:0 0 8px 0">Resumo</h4>
          <p class="muted" id="summaryText">Nenhum registro.</p>
        </div>
      </aside>
    </div>

    <!-- instruções (fixas) -->
    <div class="card" id="instructionsCard" style="margin-top:12px;margin-bottom:6px;padding:12px;border-radius:12px;">
      <div style="display:flex;align-items:flex-start;gap:12px">
        <i class="fa-solid fa-circle-info" style="font-size:20px;color:var(--accent)"></i>
        <div>
          <strong style="display:block;margin-bottom:6px">Instruções de Uso</strong>
          <div style="font-size:13px;color:var(--muted);">
            <div class="instr-step"><strong>Passo a passo</strong>
              <ol style="margin:6px 0 8px 18px;color:var(--muted)">
                <li>Preencha <strong>Subcontratada</strong> uma única vez no formulário à direita.</li>
                <li>Use o campo <strong>Nome</strong> para adicionar cada colaborador (sem apelidos).</li>
                <li>Preencha <strong>OT (Embarcação)</strong>: digite apenas números (ex: 430).</li>
                <li>Preencha <strong>Motivo</strong>: detalhe sucinto (ex: Bloco D1).</li>
                <li>Escolha o <strong>Dia da hora extra</strong> (Hoje ou Sábado) - será usado no "Dia HE".</li>
                <li>Clique em "Adicionar" para gravar ou use Enter; use "Exportar" para baixar os dados.</li>
              </ol>
            </div>
            <div style="margin-top:6px"><strong>Regras importantes</strong>
              <ul style="margin:6px 0 0 18px;color:var(--muted)">
                <li><strong>Sem apelidos:</strong> o campo Nome deve conter o nome oficial do colaborador (ex.: João Silva, não "Joãozinho").</li>
                <li><strong>Nomes repetidos:</strong> se houver colaboradores com o mesmo nome, informe também o <em>sobrenome</em>.</li>
                <li><strong>Subcontratada:</strong> preencha apenas uma vez; será aplicada a todos os colaboradores adicionados.</li>
                <li><strong>OT:</strong> somente números; entradas com letras serão recusadas.</li>
                <li><strong>Motivo:</strong> use informações do bloco e local em que vai ser trabalhado (ex.: "Bloco D1").</li>
              </ul>
            </div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">Observação: estas instruções são fixas e podem ser alteradas conforme necessário.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="dev-note reveal">
        <div>Sistema desenvolvido por <strong>Gustavo Carvalho</strong></div>
        <div>Setor de <strong>Estrutura</strong></div>
        <span class="meta">Agilidade, confiabilidade e design de excelência — pensado para líderes de obra que buscam precisão e confiança • © 2025</span>
      </div>
  </div>

  </div>

  <!-- modal -->
  <div id="modalBack" class="modal-backdrop" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 8px">Adicionar Membro</h3>
      <div>
        <div class="row">
          <div class="col">
            <label>Nome</label>
            <input id="modalName" type="text" placeholder="Nome do colaborador" />
          </div>
        </div>
        <div style="height:10px"></div>
        <label>OT (Embarcação)</label>
        <input id="modalOT" type="text" inputmode="numeric" pattern="\d*" maxlength="6" placeholder="Ex: 430" aria-label="OT (somente números)" />
        <div style="height:10px"></div>
        <label>Motivo</label>
        <textarea id="modalMotivo" placeholder="Ex: Bloco D1"></textarea>

        <div style="height:10px"></div>
        <label>Dia da hora extra</label>
        <select id="modalDia">
          <option value="hoje" selected>Hoje</option>
          <option value="sabado">Sábado (próximo)</option>
        </select>

        <div class="actions">
          <button id="modalCancel" class="btn secondary">Cancelar</button>
          <button id="modalSave" class="btn">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modais e indicadores -->
  <div id="notificationModal" class="notification-modal" style="display:none">
    <div class="notification-content">
      <p id="notificationMessage" style="display:flex;align-items:center;gap:10px">
        <i class="fas fa-info-circle" style="color:var(--accent-strong);"></i>
        <span id="notificationText">Mensagem</span>
      </p>
      <div style="display:flex;justify-content:center">
        <button id="notificationOkBtn">OK</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  setupModalHandlers();
});

(function(){
  // ---------- ELEMENTS ----------
  const btnAddMember = document.getElementById('btnAddMember');
  const btnExport = document.getElementById('btnExport'); // gera PDF agora
  const btnClear = document.getElementById('btnClear');
  const tableBody = document.querySelector('#membersTable tbody');
  const emptyState = document.getElementById('emptyState');
  const countPill = document.getElementById('countPill');
  const lastUpdate = document.getElementById('lastUpdate');
  const summaryText = document.getElementById('summaryText');

  const modalBack = document.getElementById('modalBack');
  const modalName = document.getElementById('modalName');
  const modalOT = document.getElementById('modalOT');
  const modalMotivo = document.getElementById('modalMotivo');
  const modalDia = document.getElementById('modalDia');
  const modalCancel = document.getElementById('modalCancel');
  const modalSave = document.getElementById('modalSave');

  const quickName = document.getElementById('quickName');
  const quickOT = document.getElementById('quickOT');
  const quickMotivo = document.getElementById('quickMotivo');
  const quickDia = document.getElementById('quickDia');
  const quickAdd = document.getElementById('quickAdd');
  const quickClear = document.getElementById('quickClear');

  const companyNameInput = document.getElementById('companyName');

  let members = [];

  // ---------- UTILITIES ----------
  function fmtTime(d){
    const dt = new Date(d);
    return dt.toLocaleString();
  }

  // Accepts either 'YYYY-MM-DD' (local date) OR a full ISO string; returns dd/mm/yyyy
  function fmtDateISOtoDisplay(iso){
    if(!iso) return '—';
    try{
      // if it's exactly YYYY-MM-DD -> parse as local date
      if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){
        const [yy,mm,dd] = iso.split('-').map(Number);
        const d = new Date(yy, mm-1, dd); // local midnight
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      }
      // otherwise try normal Date parsing (can be ISO with timezone)
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    }catch(e){ return iso; }
  }

  function getCompanyName(){
    return (companyNameInput.value || '').trim();
  }

  // helper: returns local date string YYYY-MM-DD
  function localDateToYYYYMMDD(dateObj){
    const d = dateObj instanceof Date ? dateObj : new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  // computeDateForChoice now RETURNS YYYY-MM-DD (local date string) to avoid UTC shift
  function computeDateForChoice(choice){
    const now = new Date();
    if(choice === 'hoje') {
      const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // local midnight
      return localDateToYYYYMMDD(d);
    }
    if(choice === 'sabado') {
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const day = today.getDay();
      const delta = (6 - day + 7) % 7;
      const target = new Date(today);
      target.setDate(today.getDate() + delta);
      const norm = new Date(target.getFullYear(), target.getMonth(), target.getDate());
      return localDateToYYYYMMDD(norm);
    }
    return localDateToYYYYMMDD(new Date(now.getFullYear(), now.getMonth(), now.getDate()));
  }

  // ---------- RENDER TABLE (OT after Name) ----------
  function render(){
    tableBody.innerHTML = '';
    const company = getCompanyName();
    if(members.length === 0){
      emptyState.style.display = 'block';
      document.getElementById('tableWrap').style.display = 'none';
    } else {
      emptyState.style.display = 'none';
      document.getElementById('tableWrap').style.display = 'block';
    }

    members.forEach((m, idx)=>{
      const heDateDisplay = fmtDateISOtoDisplay(m.extraDate || m.addedAt);
      const tr = document.createElement('tr');
      // Col order: Nome | OT | Subcontratada | Motivo | Dia HE | Adicionado | action
      tr.innerHTML = `
        <td data-label="Nome"><strong>${escapeHtml(m.name)}</strong></td>
        <td data-label="OT"><span class="pill">${escapeHtml(m.ot)}</span></td>
        <td data-label="Subcontratada">${escapeHtml(company)}</td>
        <td data-label="Motivo" class="muted">${escapeHtml(m.motivo)}</td>
        <td data-label="Dia HE" class="time">${heDateDisplay}</td>
        <td data-label="Adicionado" class="time">${fmtTime(m.addedAt)}</td>
        <td data-label="" style="text-align:right">
          <button class="icon-btn" data-idx="${idx}" title="Remover" aria-label="Remover registro"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;
      tableBody.appendChild(tr);
    });

    tableBody.querySelectorAll('button.icon-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-idx'));
        if (!Number.isNaN(i)) removeAt(i);
      });
    });

    countPill.textContent = String(members.length);
    lastUpdate.textContent = members.length ? `Último: ${fmtTime(members[members.length-1].addedAt)}` : '—';
    summaryText.textContent = members.length ? `${members.length} registro(s) nesta sessão.` : 'Nenhum registro.';

    try{
      sessionStorage.setItem('he_sub_members', JSON.stringify(members));
      sessionStorage.setItem('he_sub_company', getCompanyName());
    }catch(e){}
  }

  function removeAt(i){
    members.splice(i,1);
    render();
  }

  // ---------- VALIDATION & HELPERS ----------
  function addMember(name, ot, motivo, extraDate){
    const company = getCompanyName();
    name = (name||'').trim();
    ot = (ot||'').trim();
    motivo = (motivo||'').trim();
    // default extraDate now local YYYY-MM-DD
    extraDate = extraDate || localDateToYYYYMMDD(new Date());

    if(!company) return {ok:false,msg:'Preencha o campo "Subcontratada" antes de adicionar colaboradores.'};
    if (hasInvalidNameChars(company)) return {ok:false,msg:'Nome da Subcontratada contém caracteres inválidos ou números.'};

    if(!name) return {ok:false,msg:'Nome é obrigatório.'};
    if (hasInvalidNameChars(name)) return {ok:false,msg:'Nome do colaborador contém números ou caracteres inválidos.'};

    if(!ot || !/^\d+$/.test(ot)) return {ok:false,msg:'OT (Embarcação) é obrigatório e deve conter apenas números.'};
    if(!motivo) return {ok:false,msg:'Motivo é obrigatório.'};

    members.push({name,ot,motivo,addedAt:new Date().toISOString(), extraDate});
    render();
    return {ok:true};
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; });
  }

  function onlyDigitsInput(el, maxLen=6){
    if(!el) return;
    el.addEventListener('input', ()=>{
      const v = el.value.replace(/\D/g,'').slice(0,maxLen);
      if(el.value !== v) el.value = v;
    });
    el.addEventListener('paste', (e)=>{
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,maxLen);
      const start = el.selectionStart || el.value.length;
      const before = el.value.slice(0, start);
      const after = el.value.slice((el.selectionEnd || start));
      el.value = (before + text + after).slice(0, maxLen);
      const pos = Math.min((before+text).length, maxLen);
      el.setSelectionRange(pos,pos);
      el.dispatchEvent(new Event('input', { bubbles: true }));
    });
    el.addEventListener('keydown', (e)=>{
      const allowedKeys = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
      if(allowedKeys.includes(e.key)) return;
      if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','A','C','V','X'].includes(e.key)) return;
      if(!/^[0-9]$/.test(e.key)) e.preventDefault();
    });
  }
  onlyDigitsInput(quickOT, 6);
  onlyDigitsInput(modalOT, 6);

  function onlyLettersInput(el, maxLen = 80) {
    if (!el) return;
    const sanitize = (s) => {
      s = String(s || '').normalize('NFKC');
      s = s.replace(/\d+/g, '');
      try {
        return s.replace(/[^\p{L}\s.'-]/gu, '').slice(0, maxLen);
      } catch (e) {
        return s.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ\s.'-]/g, '').slice(0, maxLen);
      }
    };
    el.addEventListener('input', (ev) => {
      const old = el.value;
      const cleaned = sanitize(old);
      if (old !== cleaned) {
        el.value = cleaned;
        try { el.setSelectionRange(cleaned.length, cleaned.length); } catch(e){}
      }
    });
    el.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text') || '';
      const cleaned = sanitize(text);
      const start = el.selectionStart || el.value.length;
      const before = el.value.slice(0, start);
      const after = el.value.slice(el.selectionEnd || start);
      el.value = (before + cleaned + after).slice(0, maxLen);
      try { el.setSelectionRange((before + cleaned).length, (before + cleaned).length); } catch(e){}
      el.dispatchEvent(new Event('input', { bubbles: true }));
    });
    el.addEventListener('keydown', (e) => {
      const allowedKeys = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End','Enter'];
      if (allowedKeys.includes(e.key)) return;
      if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','A','C','V','X'].includes(e.key)) return;
      if (/^[0-9]$/.test(e.key)) e.preventDefault();
      if (/[`~@#$%^&*()_=+\[\]{};:"\\|<>\/?]/.test(e.key)) e.preventDefault();
    });
  }

  function hasInvalidNameChars(s) {
    if (!s) return true;
    s = String(s).normalize('NFKC').trim();
    if (/\d/.test(s)) return true;
    try {
      return /[^\p{L}\s.'-]/u.test(s);
    } catch (e) {
      return /[^A-Za-zÀ-ÖØ-öø-ÿ\s.'-]/.test(s);
    }
  }
  onlyLettersInput(companyNameInput, 80);
  onlyLettersInput(quickName, 60);
  onlyLettersInput(modalName, 60);

  // Motivo sanitization
  function sanitizeMotivo(s, maxLen = 120) {
    s = String(s || '').normalize('NFKC');
    try {
      return s.replace(/[^\p{L}\p{N}\s.\-\/,():º%]/gu, '').slice(0, maxLen);
    } catch (e) {
      return s.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ0-9\s.\-\/,():º%]/g, '').slice(0, maxLen);
    }
  }
  function onlyMotivoInput(el, maxLen = 120) {
    if (!el) return;
    el.addEventListener('input', () => {
      const old = el.value;
      const cleaned = sanitizeMotivo(old, maxLen);
      if (old !== cleaned) {
        const pos = el.selectionStart;
        el.value = cleaned;
        try { el.setSelectionRange(cleaned.length, cleaned.length); } catch(e){}
      }
    });
    el.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text') || '';
      const cleaned = sanitizeMotivo(text, maxLen);
      const start = el.selectionStart || el.value.length;
      const before = el.value.slice(0, start);
      const after = el.value.slice(el.selectionEnd || start);
      el.value = (before + cleaned + after).slice(0, maxLen);
      try { el.setSelectionRange((before + cleaned).length, (before + cleaned).length); } catch(e){}
      el.dispatchEvent(new Event('input', { bubbles: true }));
    });
    el.addEventListener('keydown', (e) => {
      const allowedKeys = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End','Enter'];
      if (allowedKeys.includes(e.key)) return;
      if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','A','C','V','X'].includes(e.key)) return;
      if (/[^0-9a-zA-Z\s.\-\/,():º%çÇáéíóúàèìòùâêîôûãõÁÉÍÓÚÀÈÌÒÙÂÊÎÔÛÃÕ!?"'@#\$%\^&\*\+=\[\]{}\\|<>`~]/.test(e.key)) {
        e.preventDefault();
      }
    });
  }
  onlyMotivoInput(quickMotivo, 100);
  onlyMotivoInput(modalMotivo, 100);

  // ---------- MODAL HANDLERS ----------
  function openModal(){
    modalBack.style.display = 'flex';
    modalBack.setAttribute('aria-hidden','false');
    modalName.focus();
  }
  function closeModal(){
    modalBack.style.display = 'none';
    modalBack.setAttribute('aria-hidden','true');
    modalName.value = '';
    modalMotivo.value = '';
    modalOT.value = '';
    modalDia.value = 'hoje';
  }

  btnAddMember.addEventListener('click', openModal);
  modalCancel.addEventListener('click', closeModal);
  modalBack.addEventListener('click', (e)=>{ if(e.target === modalBack) closeModal(); });

  modalSave.addEventListener('click', ()=>{
    const name = modalName.value.trim();
    const ot = modalOT.value.trim();
    const motivo = modalMotivo.value.trim();
    const diaChoice = (modalDia && modalDia.value) ? modalDia.value : 'hoje';
    const extraDate = computeDateForChoice(diaChoice);
    const res = addMember(name,ot,motivo,extraDate);
    if(!res.ok){ showNotification(res.msg, 'warning'); return; }
    closeModal();
    showNotification('Colaborador adicionado.', 'success');
  });

  quickAdd.addEventListener('click', ()=>{
    const diaChoice = (quickDia && quickDia.value) ? quickDia.value : 'hoje';
    const extraDate = computeDateForChoice(diaChoice);
    const res = addMember(quickName.value, quickOT.value, quickMotivo.value, extraDate);
    if(!res.ok){ showNotification(res.msg, 'warning'); return; }
    quickName.value = '';
    quickMotivo.value = '';
    quickOT.value = '';
    quickDia.value = 'hoje';
    quickName.focus();
    showNotification('Colaborador adicionado.', 'success');
  });

  quickClear.addEventListener('click', ()=>{ quickName.value=''; quickMotivo.value=''; quickOT.value=''; quickDia.value='hoje'; quickName.focus(); });

  [quickName, quickMotivo, quickOT, companyNameInput].forEach(el=>{
    if(!el) return;
    el.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        if(el === companyNameInput){
          e.preventDefault();
          quickName.focus();
          return;
        }
        e.preventDefault(); quickAdd.click();
      }
    })
  });

  [modalName, modalMotivo, modalOT].forEach(el=>{
    if(!el) return;
    el.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && (el === modalName)){
        e.preventDefault(); modalOT.focus();
      }
    })
  });

  // ---------- PDF GENERATION (using terceiros.jpg) ----------
  const pdfTemplateUrl = './terceiros.jpg'; // <--- arquivo que você informou
  const jspdfLib = window.jspdf;

  async function loadImageAsDataURL(url) {
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const blob = await res.blob();
      return await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    } catch (err) {
      console.warn('loadImageAsDataURL falhou:', err);
      return null;
    }
  }

  // formatDateForPdf now accepts YYYY-MM-DD or full ISO and returns dd/mm/yyyy
  function formatDateForPdf(isoOrDate){
    if(!isoOrDate) return '-';
    try {
      if(/^\d{4}-\d{2}-\d{2}$/.test(isoOrDate)){
        const [yy,mm,dd] = isoOrDate.split('-').map(Number);
        return `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yy}`;
      }
      const d = new Date(isoOrDate);
      if (Number.isNaN(d.getTime())) return isoOrDate;
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    } catch(e) { return isoOrDate; }
  }

  // Compute HE time range (returns string like "Horário HE: 17:00 - 18:00")
  // Input: dateStr in YYYY-MM-DD (local) or ISO; uses local weekday.
  function computeTimeRangeFromDate(dateStr){
    if(!dateStr) return '';
    let d;
    if(/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
      const [yy,mm,dd] = dateStr.split('-').map(Number);
      d = new Date(yy, mm-1, dd);
    } else {
      d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return '';
    }
    const day = d.getDay(); // 0=Sun,1=Mon,...6=Sat
    // Mon-Thu -> 17:00 - 18:00 (1..4)
    if(day >= 1 && day <= 4) return '17:00    18:00';
    // Fri -> 16:00 - 18:00 (5)
    if(day === 5) return '16:00    18:00';
    // Sat -> 07:00 - 16:00 (6)
    if(day === 6) return '07:00    16:00';
    // Sun or other -> no schedule (empty)
    return '';
  }

  // Coordinates tuned to match seu template (ajuste em PDF_COORDS se quiser refinar)
  // Adicionada propriedade xHora,yHora para controlar onde o horário será escrito no PDF.
  const PDF_COORDS = {
    companyX: 141,        // Subcontratada (campo)
    companyY: 103,
    dateX: 370,          // DATA: posição aproximada (direita)
    dateY: 103,
    xHora: 443,          // posição para desenhar o horário HE (pode ajustar)
    yHora: 142,
    tableStartY: 142,    // início da área de nomes (ajuste vertical)
    xName: 73,           // coluna NOME (esquerda)
    xOT: 254,            // coluna OT (após nome)
    xMotivo: 285,        // coluna MOTIVO (após OT)
    rightLimit: 540,     // limite direito da área de escrita
    rowHeight: 12,       // altura de linha
    topMargin: 48,
    bottomMargin: 72
  };

  async function generatePdfFromMembers({ company, dateOnly, members, observacoesGerais }) {
    if (!jspdfLib || !jspdfLib.jsPDF) throw new Error('jsPDF não carregado');
    const { jsPDF } = jspdfLib;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    const imgData = await loadImageAsDataURL(pdfTemplateUrl);

    function drawTemplate() {
      if (imgData) {
        try { doc.addImage(imgData, 'JPEG', 0, 0, pageW, pageH); }
        catch (e) { doc.setFillColor(255,255,255); doc.rect(0,0,pageW,pageH,'F'); }
      } else {
        doc.setFillColor(255,255,255); doc.rect(0,0,pageW,pageH,'F');
      }
    }

    // Prepare layout
    const coords = PDF_COORDS;
    const nameMaxWidth = coords.xOT - coords.xName - 8;
    const motivoMaxWidth = Math.max(80, coords.rightLimit - coords.xMotivo - 8);

    // helper that keeps the name single-line with ellipsis if needed
    function getSingleLineText(text, maxWidth){
      const arr = doc.splitTextToSize(String(text || ''), maxWidth);
      if (!arr.length) return '-';
      let first = arr[0];
      if (arr.length > 1) {
        while (doc.getTextWidth(first + '…') > maxWidth && first.length > 0) first = first.slice(0, -1);
        first = first + '…';
      }
      return first;
    }

    // Draw pages
    const availableHeight = pageH - coords.tableStartY - coords.bottomMargin;
    const rowsPerPage = Math.floor(availableHeight / coords.rowHeight);
    let pageIndex = 0;
    let idx = 0;

    while (idx < members.length) {
      if (pageIndex > 0) doc.addPage();
      drawTemplate();

      // Header: company and date coordinates tuned
      doc.setFont('Helvetica','bold');
      doc.setFontSize(11);
      // Use uppercase for company in PDF (optional). If you prefer not, remove .toLocaleUpperCase()
      doc.text(String((company || '-').toLocaleUpperCase('pt-BR')), coords.companyX, coords.companyY);

      doc.setFont('Helvetica','normal');
      doc.setFontSize(10);
      doc.text(String(formatDateForPdf(dateOnly)), coords.dateX, coords.dateY);

      // --- compute and render horário HE (invisible elsewhere) ---
      const horario = computeTimeRangeFromDate(dateOnly);
      if(horario){
        doc.setFontSize(10);
        doc.text(horario, coords.xHora, coords.yHora);
      }

      // Rows
      let y = coords.tableStartY;
      for (let r = 0; r < rowsPerPage && idx < members.length; r++, idx++) {
        const m = members[idx];
        const nameText = getSingleLineText(m.name || '-', nameMaxWidth);
        const otText = String(m.ot || '-');
        const motivoText = getSingleLineText(m.motivo || '-', motivoMaxWidth);

        doc.setFontSize(9);
        doc.text(nameText, coords.xName, y);
        doc.text(otText, coords.xOT, y);
        doc.text(motivoText, coords.xMotivo, y);

        y += coords.rowHeight;
      }

      pageIndex++;
    }

    // Observações (se houver) - desenha após a última página
    if (observacoesGerais) {
      // adiciona texto de observação na última página (ou nova se não couber)
      const obsLines = doc.splitTextToSize(String(observacoesGerais), pageW - coords.topMargin*2);
      let obsY = Math.max(coords.tableStartY + rowsPerPage * coords.rowHeight + 10, pageH - coords.bottomMargin - obsLines.length*12 - 10);
      if (obsY + obsLines.length * 12 > pageH - 20) {
        doc.addPage();
        drawTemplate();
        obsY = 80;
      }
      doc.setFontSize(9);
      doc.text('Observações:', coords.topMargin, obsY);
      obsY += 12;
      obsLines.forEach(line => {
        doc.text(line, coords.topMargin, obsY);
        obsY += 12;
      });
    }

    const safeCompany = String(company || 'company').replace(/[^a-z0-9_-]/ig,'').slice(0,30);
    const safeDate = String(dateOnly || localDateToYYYYMMDD(new Date())).replace(/[^0-9_-]/g,'');
    const fileName = `hora_extra_${safeCompany}_${safeDate}.pdf`;
    doc.save(fileName);
  }

  // ---------- Attach export button ----------
  btnExport.addEventListener('click', async ()=>{
    if(members.length === 0){ showNotification('Nenhum registro para gerar PDF.','warning'); return; }
    if (!window.jspdf || !window.jspdf.jsPDF) {
      showNotification('Biblioteca jsPDF não encontrada. Verifique a inclusão do CDN.', 'error');
      console.error('jsPDF não carregado (window.jspdf):', window.jspdf);
      return;
    }

    const company = getCompanyName() || (document.getElementById('companyName')||{}).value || '';
    // members[0].extraDate is now YYYY-MM-DD (local) — use it directly. If absent, use local fallback.
    const fallbackLocal = localDateToYYYYMMDD(new Date());
    const dateOnly = (members[0] && members[0].extraDate) ? members[0].extraDate : fallbackLocal;
    const observacoesGerais = ''; // se precisar, preencha

    const payload = { company, dateOnly, members, observacoesGerais };

    try {
      btnExport.disabled = true;
      await generatePdfFromMembers(payload);
      btnExport.disabled = false;
    } catch (err) {
      btnExport.disabled = false;
      console.error(err);
      showNotification('Erro ao gerar PDF: ' + (err.message || err), 'error');
    }
  });

  // ---------- Clear + hydrate ----------
  btnClear.addEventListener('click', ()=>{
    if(!confirm('Tem certeza que deseja limpar todos os registros desta sessão?')) return;
    members = [];
    sessionStorage.removeItem('he_sub_members');
    render();
  });

  try{
    const prev = sessionStorage.getItem('he_sub_members');
    if(prev){ members = JSON.parse(prev) || []; }
    const savedCompany = sessionStorage.getItem('he_sub_company');
    if(savedCompany) companyNameInput.value = savedCompany;
  }catch(e){ members = []; }

  companyNameInput.addEventListener('input', ()=>{
    try{ sessionStorage.setItem('he_sub_company', getCompanyName()); }catch(e){}
    render();
  });

  render();

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modalBack.style.display === 'flex') closeModal();
  });

  window.__heRender = render;

})(); // end iife

// ---------- Notifications & helpers ----------
function showNotification(message, type = "info") {
  const modal = document.getElementById("notificationModal");
  if (!modal) { alert(message); return; }

  let msg = document.getElementById("notificationMessage");
  if (!msg) {
    msg = document.createElement('p');
    msg.id = 'notificationMessage';
    msg.style.display = 'flex';
    msg.style.alignItems = 'center';
    msg.style.gap = '10px';
    const content = modal.querySelector('.notification-content');
    if (content) content.insertBefore(msg, content.firstChild);
  }

  const iconClass = {
    success: 'fas fa-check-circle',
    error: 'fas fa-times-circle',
    warning: 'fas fa-exclamation-triangle',
    info: 'fas fa-info-circle',
  };

  const iconWrapper = document.createElement('div');
  iconWrapper.className = `notification-icon ${type}`;
  const iconEl = document.createElement('i');
  iconEl.className = iconClass[type] || iconClass.info;
  iconWrapper.appendChild(iconEl);

  let textEl = document.getElementById('notificationText');
  if (!textEl) {
    textEl = document.createElement('div');
    textEl.id = 'notificationText';
    textEl.className = 'notification-text';
  }
  textEl.textContent = message;

  msg.innerHTML = '';
  msg.appendChild(iconWrapper);
  msg.appendChild(textEl);

  let okBtn = document.getElementById("notificationOkBtn");
  if (!okBtn) {
    const btn = document.createElement('button');
    btn.id = 'notificationOkBtn';
    btn.textContent = 'OK';
    const content = modal.querySelector('.notification-content');
    if (content) content.appendChild(btn);
    okBtn = document.getElementById("notificationOkBtn");
  }

  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("show"), 10);

  okBtn.replaceWith(okBtn.cloneNode(true));
  okBtn = document.getElementById("notificationOkBtn");
  okBtn.addEventListener('click', closeNotification);

  okBtn.focus();
}

function closeNotification() {
  const modal = document.getElementById("notificationModal");
  if (!modal) return;
  modal.classList.remove("show");
  setTimeout(() => {
    modal.style.display = "none";
  }, 300);
}

function setupModalHandlers() {
  const notificationModal = document.getElementById("notificationModal");
  if (notificationModal) {
    notificationModal.addEventListener("click", (e) => {
      if (e.target === notificationModal) closeNotification();
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      const notificationModal = document.getElementById("notificationModal");
      if (notificationModal && notificationModal.style.display === "flex") {
        closeNotification();
        return;
      }
      const modalBack = document.getElementById('modalBack');
      if (modalBack && modalBack.style.display === 'flex') {
        modalBack.style.display = 'none';
        modalBack.setAttribute('aria-hidden','true');
      }
    }
  });
}

// assume companyNameInput já existe
const companyNameInput = document.getElementById('companyName');
let composing = false;

companyNameInput.addEventListener('compositionstart', ()=> composing = true);
companyNameInput.addEventListener('compositionend', ()=> {
  composing = false;
  upperCasePreserveCaret(companyNameInput);
});

companyNameInput.addEventListener('input', ()=> {
  if (!composing) upperCasePreserveCaret(companyNameInput);
});

companyNameInput.addEventListener('paste', (e) => {
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData('text') || '';
  const cleaned = text.normalize('NFKC').toLocaleUpperCase('pt-BR');
  const start = companyNameInput.selectionStart || companyNameInput.value.length;
  const before = companyNameInput.value.slice(0, start);
  const after = companyNameInput.value.slice(companyNameInput.selectionEnd || start);
  companyNameInput.value = (before + cleaned + after).slice(0, 200);
  // posicione cursor após o texto colado
  const pos = (before + cleaned).length;
  try { companyNameInput.setSelectionRange(pos, pos); } catch(e){}
  // opcional: atualize storage/visual
  sessionStorage.setItem('he_sub_company', companyNameInput.value);
});

companyNameInput.addEventListener('blur', ()=> {
  // garante uppercase no blur também
  companyNameInput.value = companyNameInput.value.normalize('NFKC').toLocaleUpperCase('pt-BR');
});

// preserva caret/seleção ao transformar
function upperCasePreserveCaret(el) {
  const start = el.selectionStart;
  const end = el.selectionEnd;
  const val = el.value || '';
  const up = val.normalize('NFKC').toLocaleUpperCase('pt-BR');
  if (val !== up) {
    el.value = up;
    try { el.setSelectionRange(start, end); } catch(e) {}
  }
}

// Ao salvar/exportar: use getCompanyName().toLocaleUpperCase('pt-BR') antes de gravar/generar arquivo

</script>



</body>
</html>
